angular.module("merchantApp",["ui.router","ngAudio","ui.bootstrap","ngCookies","angularMoment","oitozero.ngSweetAlert","angular-loading-bar","ngAnimate","ngStorage","ordinal","ngFileUpload","uiGmapgoogle-maps","mgo-angular-wizard","ui.select2","frapontillo.bootstrap-switch","ui.tree","toastr","ordinal","notification"]).run(["$rootScope","$state","$cookies","ngAudio","$notification","merchantRESTSvc","$modal",function(a,b,c,d,e,f,g){a.handler=void 0,a.faye=new Faye.Client("/faye"),a.token=c.get("token"),a.sound=d.load("sounds/song1.wav"),a.sound.loop=!0,a.sound.is_playing=!1,a.isPaying="true"==c.get("isPaying")?!0:!1,a.subscribed_outlet=c.get("subscribed_outlet")||"",a.setHandler=function(b){a.handler=b},a.subscribeOutlet=function(d){a.faye.subscribe("/"+d,function(c){var d;if(a.handler)a.handler(c);else{console.log("faye message",c),console.log("message outside panel",c),a.notification_count+=1,a.sound.is_playing||(a.sound.is_playing=!0,a.sound.play()),d="new"===c.type?"New Order":"Order Update";var f=e(d,{body:c.message||"You have an order",delay:0,dir:"auto"});f.$on("click",function(){console.debug("The user has clicked in my notification."),b.go("merchant.default",{show:c.type},{reload:!0}),f.close()}),f.$on("close",function(){console.debug("The user has closed my notification."),f.close(),a.notification_count-=1,a.notification_count||(a.sound.stop(),a.sound.is_playing=!1)})}}),a.subscribed_outlet&&a.faye.unsubscribe("/"+a.subscribed_outlet),c.put("subscribed_outlet",d),a.subscribed_outlet=d},a.subscribed_outlet&&a.subscribeOutlet(a.subscribed_outlet),a.$on("$stateChangeStart",function(b,c,b,d){"merchant.default"===d.name&&(a.handler=void 0),$("document").ready(function(){$(window).scrollTop(0)}),a.current_state=c.name})}]).config(["$stateProvider","$urlRouterProvider","uiGmapGoogleMapApiProvider",function(a,b,c){c.configure({key:"AIzaSyBnVRxlTwkki9mi7GwRNv3SRseL6RNQRSI",v:"3.17",libraries:"weather,geometry,visualization,drawing"}),b.when("","/"),b.otherwise("/"),a.state("merchant",{url:"",templateUrl:"templates/header.html",controller:"RootController"}).state("merchant.default",{url:"/?show",templateUrl:"templates/panel.html",controller:"OrderManageController"}).state("merchant.login",{url:"/login",templateUrl:"templates/login.html",controller:"LoginController"}).state("merchant.outlets_manage",{url:"/outlets/manage",templateUrl:"templates/outlets/manage.html",controller:"OutletManageController"}).state("merchant.outlets_create",{url:"/outlets/create",templateUrl:"templates/outlets/create.html",controller:"OutletCreateController"}).state("merchant.outlets_edit",{url:"/outlets/edit/:outlet_id",templateUrl:"templates/outlets/edit.html",controller:"OutletEditController"}).state("merchant.outlets_view",{url:"/outlets/view/:outlet_id",templateUrl:"templates/outlets/view.html",controller:"OutletViewController"}).state("merchant.menus_manage",{url:"/menus/manage",templateUrl:"templates/menus/manage.html",controller:"MenuManageController"}).state("merchant.menus_edit",{url:"/menus/edit/:menu_id",templateUrl:"templates/menus/edit.html",controller:"MenuEditController"}).state("merchant.menus_request_update",{url:"/menus/request/:menu_id",templateUrl:"templates/menus/request.html",controller:"MenuRequestUpdateController"}).state("merchant.menus_view",{url:"/menus/view/:menu_id",templateUrl:"templates/menus/view.html",controller:"MenuViewController"}).state("merchant.offers_manage",{url:"/offers/manage",templateUrl:"templates/offers/manage.html",controller:"OfferManageController"}).state("merchant.offers_create",{url:"/offers/create",templateUrl:"templates/offers/create.html",controller:"OfferCreateController"}).state("merchant.offers_edit",{url:"/offers/edit/:offer_id",templateUrl:"templates/offers/edit.html",controller:"OfferEditController"}).state("merchant.offers_view",{url:"/offers/view/:offer_id",templateUrl:"templates/offers/view.html",controller:"OfferViewController"}).state("merchant.bills_manage",{url:"/bills/manage",templateUrl:"templates/bills/manage.html",controller:"BillManageController"}).state("merchant.bills_view",{url:"/bills/view/:bill_id",templateUrl:"templates/bills/view.html",controller:"BillViewController"})}]),angular.module("merchantApp").controller("BillManageController",["$scope","merchantRESTSvc","SweetAlert",function(a,b,c){_id=void 0,a.filters={userId:"",outletName:"",date:"",status:""},a.sort_order={oldest_first:"Oldest First",newest_first:"Newest First"},a.view_options={submitted:"Submitted",twyst_approved:"Twyst Approved",twyst_rejected:"Twyst Rejected",outlet_pending:"Outlet Pending",outlet_approved:"Outlet Approved",outlet_pending:"Outlet Pending",archived:"Archived"},a.sort="oldest_first",a.view_by="submitted",a.updateSortOrder=function(b){a.sort=b},a.updateViewBy=function(b){a.view_by=b},a.billFilter=function(b){var c=new RegExp(a.filters.userId,"i"),d=new RegExp(a.filters.outletName,"i"),e=new RegExp(a.filters.status,"i");return c.test(b.event_user)&&d.test(b.event_meta.outlet_name)&&e.test(b.event_meta.status)},a.getBills=function(){b.getBills(a.view_by,a.sort).then(function(b){a.bills=b.data},function(a){var b=a.message?a.message:"Something went wrong.";c.swal({title:"ERROR",text:b,type:"error",showCancelButton:!1,confirmButtonColor:"#DD6B55",confirmButtonText:"Continue",closeOnConfirm:!0})})}}]),angular.module("merchantApp").controller("BillViewController",["$scope","merchantRESTSvc","SweetAlert","$stateParams",function(a,b,c,d){b.getBill(d.bill_id).then(function(b){a.bill=b.data},function(a){console.log(a)}),a.approveBill=function(){a.bill.event_meta.status="outlet_approved",b.updatebill(a.bill).then(function(b){a.bill=b.data},function(a){console.log(a)})},a.rejectBill=function(){a.bill.evnet_meta.status="outlet_rejected",b.updatebill(a.bill).then(function(b){a.bill=b.data},function(a){console.log(a)})}}]),angular.module("merchantApp").controller("LoginController",["$scope","$rootScope","merchantRESTSvc","$state","$cookies","SweetAlert","$timeout",function(a,b,c,d,e,f,g){a.user={isMerchant:!0},b.token&&d.go("merchant.default",{},{reload:!0}),a.logIn=function(){c.login(a.user).then(function(a){e.put("token",a.data.data.token),e.put("isPaying",a.data.data.is_paying),b.token=a.data.data.token,b.isPaying=a.data.data.is_paying,a.data.data.outlets&&a.data.data.outlets.length&&b.subscribeOutlet(a.data.data.outlets[0]),f.swal({title:"Logged In Successfully",type:"success",showCancelButton:!1,confirmButtonText:"Continue",closeOnConfirm:!1},function(){d.go("merchant.default",{},{reload:!0})})},function(a){var b;b=a.data?a.data:"Invalid credentials",f.swal({title:"ERROR",text:b,type:"error",showCancelButton:!1,closeOnConfirm:!0})})}}]),angular.module("merchantApp").controller("MenuEditController",["$scope","merchantRESTSvc","SweetAlert","$state","$q","$modal","$stateParams",function(a,b,c,d,e,f,g){a.menu_types=["Dine-In","Takeaway","Delivery","Weekend","Dinner","All"],b.getOutlets().then(function(b){a.outlets=b.data,a.getMenu()},function(b){a.outlets=[],console.log(b),a.getMenu()}),a.getMenu=function(){b.getMenu(g.menu_id).then(function(b){a.menu=_.extend(a.menu,b.data),_id=a.menu._id},function(a){a.message?c.swal("Service Error",a.message,"error"):c.swal("Service Error","Something went wrong.","error")})},a.menu={status:"active",menu_categories:[]},a.toggle=function(a){a.toggle()},a.cloneCategory=function(b){c.swal({title:"Clone category!",text:"Are you sure you want to clone this category?",type:"info",showCancelButton:!0,confirmButtonText:"Clone It!"},function(c){if(c){var d=_.cloneDeep(a.menu.menu_categories[b]);delete d._id,_.each(d.sub_categories,function(a){delete a._id,_.each(a.items,function(a){delete a._id,_.each(a.options,function(a){delete a._id,_.each(a.sub_options,function(a){delete a._id,_.each(a.sub_option_set,function(a){delete a._id})}),_.each(a.addons,function(a){delete a._id,_.each(a.addon_set,function(a){delete a._id})})})})}),a.menu.menu_categories.push(_.cloneDeep(a.menu.menu_categories[b]))}})},a.editCategory=function(b){var c=f.open({animation:!0,templateUrl:"../common/templates/partials/menu.category.tmpl.html",controller:"MenuCategoryController",size:"lg",resolve:{category:function(){return _.cloneDeep(a.menu.menu_categories[b])},is_new:function(){return!0}}});c.result.then(function(c){a.menu.menu_categories[b]=c})},a.removeCategory=function(b){c.swal({title:"Delete category!",text:"Are you sure you want to delete?",type:"warning",confirmButtonColor:"#DD6B55",showCancelButton:!0,confirmButtonText:"Delete It!"},function(c){c&&a.menu.menu_categories.splice(b,1)})},a.cloneSubCategory=function(a,b){c.swal({title:"Clone sub category!",text:"Are you sure you want to clone this sub category?",type:"info",showCancelButton:!0,confirmButtonText:"Clone It!"},function(c){if(c){var d=_.cloneDeep(a.sub_categories[b]);delete d._id,_.each(d.items,function(a){delete a._id,_.each(a.options,function(a){delete a._id,_.each(a.sub_options,function(a){delete a._id,_.each(a.sub_option_set,function(a){delete a._id})}),_.each(a.addons,function(a){delete a._id,_.each(a.addon_set,function(a){delete a._id})})})}),a.sub_categories.push(d)}})},a.editSubCategory=function(a,b){var c=f.open({animation:!0,templateUrl:"../common/templates/partials/menu.sub_category.tmpl.html",controller:"MenuSubCategoryController",size:"lg",resolve:{sub_category:function(){return _.cloneDeep(a.sub_categories[b])},is_new:function(){return!1}}});c.result.then(function(c){a.sub_categories[b]=c})},a.removeSubCategory=function(a,b){c.swal({title:"Delete sub category!",text:"Are you sure you want to delete?",type:"warning",confirmButtonColor:"#DD6B55",showCancelButton:!0,confirmButtonText:"Delete It!"},function(c){c&&a.sub_categories.splice(b,1)})},a.cloneItem=function(a,b){c.swal({title:"Clone item!",text:"Are you sure you want to clone this item?",type:"info",showCancelButton:!0,confirmButtonText:"Clone It!"},function(c){if(c){var d=_.cloneDeep(a.items[b]);delete d._id,_.each(d.options,function(a){delete a._id,_.each(a.sub_options,function(a){delete a._id,_.each(a.sub_option_set,function(a){delete a._id})}),_.each(a.addons,function(a){delete a._id,_.each(a.addon_set,function(a){delete a._id})})}),a.items.push(d)}})},a.editItem=function(a,b){var c=f.open({animation:!0,templateUrl:"../common/templates/partials/menu.item.tmpl.html",controller:"MenuItemController",size:"lg",resolve:{item:function(){return _.cloneDeep(a.items[b])},is_new:function(){return!1},limit_access:function(){return!0}}});c.result.then(function(c){a.items[b]=c})},a.removeItem=function(a,b){c.swal({title:"Delete item!",text:"Are you sure you want to delete?",type:"warning",confirmButtonColor:"#DD6B55",showCancelButton:!0,confirmButtonText:"Delete It!"},function(c){c&&a.items.splice(b,1)})},a.cloneOption=function(a,b){c.swal({title:"Clone option!",text:"Are you sure you want to clone this option?",type:"info",showCancelButton:!0,confirmButtonText:"Clone It!"},function(c){if(c){var d=_.cloneDeep(a.options[b]);delete d._id,_.each(d.sub_options,function(a){delete a._id,_.each(a.sub_option_set,function(a){delete a._id})}),_.each(d.addons,function(a){delete a._id,_.each(a.addon_set,function(a){delete a._id})}),a.options.push(d)}})},a.editOption=function(a,b){var c=f.open({animation:!0,templateUrl:"../common/templates/partials/menu.option.tmpl.html",controller:"MenuOptionController",size:"lg",resolve:{option:function(){return _.cloneDeep(a.options[b])},is_new:function(){return!1},option_title:function(){return a.option_title},limit_access:function(){return!0}}});c.result.then(function(c){a.options[b]=c})},a.removeOption=function(a,b){c.swal({title:"Delete option!",text:"Are you sure you want to delete?",type:"warning",confirmButtonColor:"#DD6B55",showCancelButton:!0,confirmButtonText:"Delete It!"},function(c){c&&a.options.splice(b,1)})},a.cloneSubOption=function(a,b){c.swal({title:"Clone sub option!",text:"Are you sure you want to clone these sub options?",type:"info",showCancelButton:!0,confirmButtonText:"Clone It!"},function(c){if(c){var d=_.cloneDeep(a.sub_options[b]);delete d._id,_.each(d.sub_option_set,function(a){delete a._id}),a.sub_options.push(d)}})},a.editSubOption=function(a,b){var c=f.open({animation:!0,templateUrl:"../common/templates/partials/menu.sub_option.tmpl.html",controller:"MenuSubOptionController",size:"lg",resolve:{sub_option:function(){return _.cloneDeep(a.sub_options[b])},is_new:function(){return!1},limit_access:function(){return!0}}});c.result.then(function(c){a.sub_options[b]=c})},a.removeSubOption=function(a,b){c.swal({title:"Delete sub option set!",text:"Are you sure you want to delete?",type:"warning",confirmButtonColor:"#DD6B55",showCancelButton:!0,confirmButtonText:"Delete It!"},function(c){c&&a.sub_options.splice(b,1)})},a.cloneAddon=function(a,b){c.swal({title:"Clone addon!",text:"Are you sure you want to clone these addons?",type:"info",showCancelButton:!0,confirmButtonText:"Clone It!"},function(c){if(c){var d=_.cloneDeep(a.addons[b]);delete d._id,_.each(d.addon_set,function(a){delete a._id}),a.addons.push(d)}})},a.editAddon=function(a,b){var c=f.open({animation:!0,templateUrl:"../common/templates/partials/menu.addon.tmpl.html",controller:"MenuAddonController",size:"lg",resolve:{addon:function(){return _.cloneDeep(a.addons[b])},is_new:function(){return!1},limit_access:function(){return!0}}});c.result.then(function(c){a.addons[b]=c})},a.removeAddon=function(a,b){c.swal({title:"Delete addon set!",text:"Are you sure you want to delete?",type:"warning",confirmButtonColor:"#DD6B55",showCancelButton:!0,confirmButtonText:"Delete It!"},function(c){c&&a.addons.splice(b,1)})},a.updateMenu=function(){a.reviewMenu().then(function(){b.updateMenu(a.menu).then(function(a){c.swal({title:"Menu updated successfully",type:"success",showCancelButton:!1,confirmButtonText:"Continue"},function(){d.go("^.menus_manage",{},{reload:!0})})},function(a){console.log(a),a.message?c.swal("Validation Error",a.message,"error"):c.swal("Service Error","Unable to update the menu right now","error")})},function(a){c.swal("Validation error",a,"error")})},a.reviewMenu=function(){var b=e.defer();return a.menu.menu_type?a.menu.menu_item_type?a.menu.outlet?a.menu.menu_categories.length?async.each(a.menu.menu_categories,function(a,b){a.sub_categories.length?async.each(a.sub_categories,function(a,b){a.items.length?b():b("Aleast one item must be present in all sub categories")},function(a){b(a)}):b("Atleast one sub category must be added to all categories")},function(a){a?b.reject(a):b.resolve()}):b.reject("Atleast one category must be added"):b.reject("Please choose an outlet"):b.reject("Please select menu items type"):b.reject("Menu type required"),b.promise}}]),angular.module("merchantApp").controller("MenuManageController",["$scope","merchantRESTSvc","SweetAlert","$modal",function(a,b,c,d){a.filters={title:"",outlet_name:"",locality1:"",locality2:""},a.getMenus=function(){b.getAllMenus().then(function(b){a.menus=b.data},function(b){a.menus=[];var d;d=b.message?b.message:"Something went wrong",c.swal({title:"ERROR",text:d,type:"error",showCancelButton:!1,confirmButtonColor:"#DD6B55",confirmButtonText:"Continue",closeOnConfirm:!0})})},a.menuFilter=function(b){var c=new RegExp(a.filters.title,"i"),d=new RegExp(a.filters.outlet_name,"i"),e=new RegExp(a.filters.locality1,"i"),f=new RegExp(a.filters.locality2,"i");return c.test(b.menu_type)&&d.test(b.outlet.name)&&e.test(b.outlet.loc1)&&f.test(b.outlet.loc2)},a.cloneMenu=function(b,c){var e=d.open({animation:!0,templateUrl:"templates/partials/menu.clone.tmpl.html",controller:"MenuCloneController",size:"lg",resolve:{menu_id:function(){return b},outlet_id:function(){return c}}});e.result.then(function(){a.getMenus()})},a.removeMenu=function(d){c.swal({title:"Are you sure?",text:"You will not be able to recover this menu",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, Delete It!",closeOnConfirm:!1},function(e){e&&b.deleteMenu(d).then(function(b){c.swal("SUCCESS","Menu deleted successfully","success"),a.getMenus()},function(a){c.swal({title:"ERROR",text:"Unable to delete this menu right now",type:"error",showCancelButton:!1,confirmButtonColor:"#DD6B55",confirmButtonText:"Continue",closeOnConfirm:!0})})})},a.requestMenuUpdate=function(a){console.log(a);d.open({animation:!0,templateUrl:"templates/partials/menu.request_update.tmpl.html",controller:"MenuRequestUpdateController",size:"md",resolve:{menu_id:function(){return a._id},outlet:function(){return a.outlet},menu_type:function(){return a.menu_type}}})}}]),angular.module("merchantApp").controller("MenuRequestUpdateController",["$scope","$modalInstance","merchantRESTSvc","menu_id","outlet","menu_type","SweetAlert",function(a,b,c,d,e,f,g){a.update_request={event_meta:{menu_id:d,outlet:e,menu_type:f,status:"pending"}},a.submitRequest=function(){a.update_request.event_meta.comment?c.menuUpdateRequest(a.update_request).then(function(a){console.log(a),g.swal({title:"Request submitted",text:"Menu update request submitted successfully",type:"success",showCancelButton:!1,confirmButtonText:"Continue",closeOnConfirm:!0},function(){b.close()})},function(a){console.log(a),g.swal({title:"ERROR",text:a.message?a.message:"Something went wrong. Please try after sometime",type:"error",showCancelButton:!1,confirmButtonText:"Continue",closeOnConfirm:!0},function(){b.close()})}):g.swal("Validation Error","Please input the changes required","error")}}]),angular.module("merchantApp").controller("MenuViewController",["$scope","merchantRESTSvc","SweetAlert","$state","$q","$modal","$stateParams",function(a,b,c,d,e,f,g){b.getOutlets().then(function(b){a.outlets=b.data,a.getMenu()},function(b){a.outlets=[],console.log(b),a.getMenu()}),a.menu={status:"active",menu_categories:[]},a.getMenu=function(){b.getMenu(g.menu_id).then(function(b){a.menu=_.extend(a.menu,b.data)},function(a){a.message?c.swal("Service Error",a.message,"error"):c.swal("Service Error","Something went wrong.","error")})},a.toggle=function(a){a.toggle()}}]),angular.module("merchantApp").controller("DeliveryZoneController",["$scope","$modalInstance","delivery_zone","is_new","is_first","merchantRESTSvc","$rootScope","SweetAlert",function(a,b,c,d,e,f,g,h){f.getOutlets().then(function(b){a.outlets=_.indexBy(b.data,"_id")},function(b){console.log(b),a.outlets={}}),a.checkModel={},a.is_new=d,a.days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],a.delivery_zone={delivery_timings:{monday:{closed:!1,timings:[{}]},tuesday:{closed:!1,timings:[{}]},wednesday:{closed:!1,timings:[{}]},thursday:{closed:!1,timings:[{}]},friday:{closed:!1,timings:[{}]},saturday:{closed:!1,timings:[{}]},sunday:{closed:!1,timings:[{}]}},order_accepts_till:{hr:"0",min:"0"}},a.delivery_zone=_.merge(a.delivery_zone,c),a.delivery_zone.order_accepts_till.time=new Date,a.delivery_zone.order_accepts_till.time.setMinutes(a.delivery_zone.order_accepts_till.min),a.delivery_zone.order_accepts_till.time.setHours(a.delivery_zone.order_accepts_till.hr),a.delivery_zone.order_accepts_till.time.setSeconds(0),a.delivery_zone.order_accepts_till.time.setMilliseconds(0),console.log("$scope.is_new",a.is_new),a.is_new||_.each(a.delivery_zone.payment_options,function(b){console.log(b),a.checkModel[b]=!0}),a.$watchCollection("checkModel",function(b){if(b){var c=_.compact(_.map(b,function(a,b){return a?b:""}));a.delivery_zone.payment_options=c}}),a.updatePackaging=function(){a.delivery_zone.has_packaging_charge?a.delivery_zone.packaging_charge={is_fixed:!0}:a.delivery_zone.packaging_charge={}},a.updateFixedCharge=function(){a.delivery_zone.packaging_charge.is_fixed?a.delivery_zone.packaging_charge.charges=[]:a.delivery_zone.packaging_charge.charges=[{}]},a.addPackagingSlab=function(){a.delivery_zone.packaging_charge.charges.push({})},a.removePackagingSlab=function(b){a.delivery_zone.packaging_charge.charges.splice(b,1)},a.getMaxRange=function(){return new Array(_.reduce(a.delivery_zone.delivery_timings,function(a,b){return _.has(a,"timings")?a.timings.length>b.timings.length?a.timings.length:b.timings.length:a>=b.timings.length?a:b.timings.length}))},a.cloneTimings=function(b){b._id&&(a.delivery_zone.delivery_timings=_.indexBy(_.map(Object.keys(a.outlets[b._id].business_hours),function(c){var d=_.map(a.outlets[b._id].business_hours[c].timings,function(a){delete a._id;var b=new Date;return b.setSeconds(0),b.setMilliseconds(0),a.open.time=_.clone(b),a.open.time.setMinutes(a.open.min),a.open.time.setHours(a.open.hr),a.close.time=_.clone(b),a.close.time.setMinutes(a.close.min),a.close.time.setHours(a.close.hr),_.cloneDeep(a)});return{day:c,timings:d,closed:a.outlets[b._id].business_hours[c].closed}}),"day"),b._id="")},a.addNewTiming=function(a,b){b[a].timings.push({})},a.removeTiming=function(a,b,c){c[a].timings.splice(b,1)},a.updateTime=function(a,b,c){var d=c[a].timings[b];d.open.time&&(d.open.hr=d.open.time.getHours(),d.open.min=d.open.time.getMinutes()),d.close.time&&(d.close.hr=d.close.time.getHours(),d.close.min=d.close.time.getMinutes())},a.updateTiming=function(a,b){b[a].closed?b[a].timings=[]:b[a].timings=[{}]},a.initalizeTiming=function(a,b,c){if(!c[a].timings[b].open||!c[a].timings[b].close){var d=new Date;g.isPaying?(d.setHours(9),d.setMinutes(0),d.setSeconds(0),d.setMilliseconds(0)):(d.setHours(0),d.setMinutes(1),d.setSeconds(0),d.setMilliseconds(0));var e=new Date;g.isPaying?(e.setHours(21),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0)):(e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0)),g.isPaying?c[a].timings[b]={open:{hr:9,min:0,time:d},close:{hr:21,min:0,time:e}}:c[a].timings[b]={open:{hr:0,min:1,time:d},close:{hr:0,min:0,time:e}}}},a.cloneToAllDays=function(a,b){_.each(b,function(c,d){d!==a&&(c.timings=_.cloneDeep(b[a].timings),c.closed=b[a].closed)})},a.resolveDeliveryZone=function(){if(a.formFailure=!1,a.delivery_zone.zone_name)if(a.delivery_zone.delivery_estimated_time)if(a.delivery_zone.min_amt_for_delivery||0===a.delivery_zone.min_amt_for_delivery)if(a.delivery_zone.delivery_charge||0===a.delivery_zone.delivery_charge)if(a.delivery_zone.payment_options&&a.delivery_zone.payment_options.length)if(a.delivery_zone.has_packaging_charge)if(a.delivery_zone.packaging_charge.is_fixed&&!a.delivery_zone.packaging_charge.value)a.formFailure=!0,h.swal("Validation error","Fixed charge amount required");else if(a.delivery_zone.packaging_charge.is_fixed||a.delivery_zone.packaging_charge.charges.length){var d=!1;async.each(a.delivery_zone.packaging_charge.charges,function(b,c){b.start||0===b.start?b.value||0===b.value?b.end?async.each(a.delivery_zone.packaging_charge.charges,function(a,c){b===a?c():b.start<=(a.end||999999)&&(a.end||999999)<=(b.end||999999)||b.start<=a.start&&a.start<=(b.end||999999)||a.start<=(b.end||999999)&&(b.end||999999)<=(a.end||999999)?c("One or more slabs are colliding. Please recheck and fix to proceed"):c()},function(a){c(a)}):d?c("Exactly one slab should not have an upper bound"):(d=!0,c()):c("Charge amount required for all slabs"):c("Start amount required for all slabs")},function(f){if(f)a.formFailure=!0,h.swal("Validation error",f,"error");else if(a.delivery_zone.packaging_charge.is_fixed||d)if(e){var g=_.cloneDeep(c),i=_.cloneDeep(a.delivery_zone);delete g.coord,delete i.coord,delete g.order_accepts_till.time,delete i.order_accepts_till.time,_.isEqual(g,i)?(a.formFailure=!0,h.swal("Validation error","Please change atleast one parameter","error")):b.close(a.delivery_zone)}else b.close(a.delivery_zone);else a.formFailure=!0,h.swal("Validation error","Exactly one slab should not have an upper bound","error")})}else h.swal("Validation error","Atleast one slab reuqired for variable packaging charge","error");else if(e){var f=_.cloneDeep(c),g=_.cloneDeep(a.delivery_zone);delete f.coord,delete g.coord,delete f.order_accepts_till.time,delete g.order_accepts_till.time,_.isEqual(f,g)?(a.formFailure=!0,h.swal("Validation error","Please change atleast one parameter","error")):b.close(a.delivery_zone)}else b.close(a.delivery_zone);else a.formFailure=!0,h.swal("Validation error","Atleast one payment option must be selected","error");else a.formFailure=!0,h.swal("Validation error","Delivery charge cannot be left blank","error");else a.formFailure=!0,h.swal("Validation error","Minimum delivery amount cannot be left blank","error");else a.formFailure=!0,h.swal("Validation error","Estimate delivery time required","error");else a.formFailure=!0,h.swal("Validation error","Zone name required","error")},a.discardDeliveryZone=function(){b.dismiss("Cancel")}}]),angular.module("merchantApp").controller("ImagePickerController",["$scope","$modalInstance",function(a,b){a.images={"north-indian":["retwyst-merchants/default-images/north-indian/1","retwyst-merchants/default-images/north-indian/2","retwyst-merchants/default-images/north-indian/3","retwyst-merchants/default-images/north-indian/4","retwyst-merchants/default-images/north-indian/5","retwyst-merchants/default-images/north-indian/6","retwyst-merchants/default-images/north-indian/7","retwyst-merchants/default-images/north-indian/8","retwyst-merchants/default-images/north-indian/9","retwyst-merchants/default-images/north-indian/10","retwyst-merchants/default-images/north-indian/11","retwyst-merchants/default-images/north-indian/12","retwyst-merchants/default-images/north-indian/13","retwyst-merchants/default-images/north-indian/14","retwyst-merchants/default-images/north-indian/15","retwyst-merchants/default-images/north-indian/16","retwyst-merchants/default-images/north-indian/17","retwyst-merchants/default-images/north-indian/18","retwyst-merchants/default-images/north-indian/19","retwyst-merchants/default-images/north-indian/20"],pizza:["retwyst-merchants/default-images/pizza/1","retwyst-merchants/default-images/pizza/2"],wrap:["retwyst-merchants/default-images/wrap/1","retwyst-merchants/default-images/wrap/2","retwyst-merchants/default-images/wrap/3"],sandwich:["retwyst-merchants/default-images/sandwich/1","retwyst-merchants/default-images/sandwich/2","retwyst-merchants/default-images/sandwich/3"],burger:["retwyst-merchants/default-images/burger/1","retwyst-merchants/default-images/burger/2","retwyst-merchants/default-images/burger/3","retwyst-merchants/default-images/burger/4"],beverages:["retwyst-merchants/default-images/beverages/1","retwyst-merchants/default-images/beverages/2","retwyst-merchants/default-images/beverages/3","retwyst-merchants/default-images/beverages/4","retwyst-merchants/default-images/beverages/5","retwyst-merchants/default-images/beverages/6","retwyst-merchants/default-images/beverages/7","retwyst-merchants/default-images/beverages/8","retwyst-merchants/default-images/beverages/9","retwyst-merchants/default-images/beverages/10"],desserts:["retwyst-merchants/default-images/desserts/1","retwyst-merchants/default-images/desserts/2","retwyst-merchants/default-images/desserts/3","retwyst-merchants/default-images/desserts/4","retwyst-merchants/default-images/desserts/5","retwyst-merchants/default-images/desserts/6","retwyst-merchants/default-images/desserts/7","retwyst-merchants/default-images/desserts/8","retwyst-merchants/default-images/desserts/9","retwyst-merchants/default-images/desserts/10","retwyst-merchants/default-images/desserts/11","retwyst-merchants/default-images/desserts/12","retwyst-merchants/default-images/desserts/13","retwyst-merchants/default-images/desserts/14"],chinese:["retwyst-merchants/default-images/chinese/1","retwyst-merchants/default-images/chinese/2","retwyst-merchants/default-images/chinese/3","retwyst-merchants/default-images/chinese/4","retwyst-merchants/default-images/chinese/5","retwyst-merchants/default-images/chinese/6","retwyst-merchants/default-images/chinese/7","retwyst-merchants/default-images/chinese/8","retwyst-merchants/default-images/chinese/9","retwyst-merchants/default-images/chinese/10","retwyst-merchants/default-images/chinese/11","retwyst-merchants/default-images/chinese/12"],"healthy-food":["retwyst-merchants/default-images/healthy-food/1","retwyst-merchants/default-images/healthy-food/2","retwyst-merchants/default-images/healthy-food/3","retwyst-merchants/default-images/healthy-food/4","retwyst-merchants/default-images/healthy-food/5"],"south-indian":["retwyst-merchants/default-images/south-indian/1","retwyst-merchants/default-images/south-indian/2"],biryani:["retwyst-merchants/default-images/biryani/1","retwyst-merchants/default-images/biryani/2","retwyst-merchants/default-images/biryani/3","retwyst-merchants/default-images/biryani/4","retwyst-merchants/default-images/biryani/5","retwyst-merchants/default-images/biryani/6","retwyst-merchants/default-images/biryani/7","retwyst-merchants/default-images/biryani/8","retwyst-merchants/default-images/biryani/9","retwyst-merchants/default-images/biryani/10"]},a.image_types={"north-indian":"North Indian",pizza:"Pizza",wrap:"Wraps",sandwich:"Sandwiches",burger:"Burgers",beverages:"Beverages",desserts:"Desserts",chinese:"Chinese","healthy-food":"Healthy Food","south-indian":"South Indian",biryani:"Biryani"},a.chooseImage=function(a){b.close(a)},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("merchantApp").controller("MenuAddonController",["$scope","$modalInstance","addon","is_new","limit_access","SweetAlert",function(a,b,c,d,e,f){a.is_new=d,a.addon=c,a.limit_access=e,a.addValuePair=function(){a.addon.addon_set.push({is_vegetarian:!0})},a.removeValuePair=function(b){a.addon.addon_set.splice(b,1)},a.resolveAddon=function(){a.addon.addon_title?a.addon.addon_set&&a.addon.addon_set.length?async.each(a.addon.addon_set,function(a,b){a.addon_value?a.addon_cost||0===a.addon_cost?b():b("No addon cost can be left blank"):b("No addon name can be left blank")},function(c){c?f.error("Validation Error",c,"error"):b.close(a.addon)}):f.swal("Validation Error","Please provide atleast one value pair","error"):f.swal("Validation Error","Title required","error")},a.discardAddon=function(){b.dismiss("Cancel")}}]),angular.module("merchantApp").controller("MenuCategoryController",["$scope","$modalInstance","category","is_new","SweetAlert",function(a,b,c,d,e){a.menu_categories=["Indian","Desserts","Cakes","Chinese","Soup"],a.is_new=d,a.category=c,a.resolveCategory=function(){a.category.category_name?b.close(a.category):e.swal("Validation Error","Category Name cannot be left blank","error")},a.discardCategory=function(){b.dismiss("Cancel")}}]),angular.module("merchantApp").controller("MenuCloneController",["$scope","$modalInstance","menu_id","outlet_id","SweetAlert","merchantRESTSvc",function(a,b,c,d,e,f){a.req_obj={menu:c},f.getOutlets().then(function(b){a.outlets=_.filter(b.data,function(a){return a._id!==d})},function(b){a.outlets=[],console.log(b)}),a.cloneMenu=function(){a.req_obj.outlet?f.cloneMenu(c,a.req_obj.outlet).then(function(a){b.close()},function(a){var c=a.message?a.message:"Unable to clone the menu right now";e.swal({title:"Service error",text:c,type:"error",showCancelButton:!1,confirmButtonColor:"#DD6B55",confirmButtonText:"Continue",closeOnConfirm:!0},function(){b.dismiss()})}):e.swal("Error!","Please select an outlet first","error")},a.cancel=function(){b.dismiss("Cancel")}}]),angular.module("merchantApp").controller("MenuItemController",["$scope","$modalInstance","$modal","item","is_new","limit_access","SweetAlert","$q",function(a,b,c,d,e,f,g,h){a.is_new=e,a.limit_access=f,a.item=d,e||(_.each(a.days,function(b){a.checkModel[b]=-1!==a.item.item_available_on.indexOf(b)?!0:!1}),a.item.item_availability.start_date&&(a.item.item_availability.start_date=new Date(a.item.item_availability.start_date)),a.item.item_availability.end_date&&(a.item.item_availability.end_date=new Date(a.item.item_availability.end_date))),a.checkModal={},a.days=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],a.$watchCollection("checkModal",function(){a.item.item_available_on=[],angular.forEach(a.checkModal,function(b,c){b&&a.item.item_available_on.push(c)})}),a.updateItemTimings=function(b,d){if(b===!0||b===!1)if(a.item.item_availability.regular_item===!0)delete a.item.item_availability.start_date,
delete a.item.item_availability.end_date,a.item.item_availability.days_of_the_week=[],a.item.item_availability.available_hours={monday:{closed:!1,timings:[{}]},tuesday:{closed:!1,timings:[{}]},wednesday:{closed:!1,timings:[{}]},thursday:{closed:!1,timings:[{}]},friday:{closed:!1,timings:[{}]},saturday:{closed:!1,timings:[{}]},sunday:{closed:!1,timings:[{}]}};else{var e=c.open({animation:!0,templateUrl:"../common/templates/partials/menu.item_timings.tmpl.html",size:"lg",controller:"MenuItemTimingsController",resolve:{item:function(){return _.cloneDeep(a.item)}}});e.result.then(function(b){a.item=b},function(){d||(a.item.item_availability.regular_item=!0)})}},a.resolveItem=function(){a.validateItem().then(function(){b.close(a.item)},function(a){g.swal("Validation Erorr",a,"error")})},a.discardItem=function(){b.dismiss("Cancel")},a.validateItem=function(){var b=h.defer();return a.item.item_name?a.item.item_cost||0===a.item.item_cost?a.item.item_tags&&a.item.item_tags.length?a.item.item_type?b.resolve():b.reject("Item type must be selected"):b.reject("Atleast one tag required"):b.reject("Item cost required."):b.reject("Item name required."),b.promise}}]),angular.module("merchantApp").controller("MenuItemTimingsController",["$scope","$modalInstance","item","SweetAlert","$q",function(a,b,c,d,e){a.item={item_availability:{available_hours:{monday:{closed:!1,timings:[{}]},tuesday:{closed:!1,timings:[{}]},wednesday:{closed:!1,timings:[{}]},thursday:{closed:!1,timings:[{}]},friday:{closed:!1,timings:[{}]},saturday:{closed:!1,timings:[{}]},sunday:{closed:!1,timings:[{}]}},days_of_the_week:["monday","tuesday","wednesday","thursday","friday","saturday","sunday"]}},a.check_days={monday:!0,tuesday:!0,wednesday:!0,thursday:!0,friday:!0,saturday:!0,sunday:!0},a.$watchCollection("check_days",function(b){b&&(a.item.item_availability.days_of_the_week=_.compact(_.map(b,function(a,b){return a?b:void 0})))}),a.days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],a.item=_.merge(a.item,c),console.log(a.item),_.each(a.days,function(b){-1===a.item.item_availability.days_of_the_week.indexOf(b)&&(a.check_days[b]=!1)}),a.item.item_availability.start_date&&(a.item.item_availability.start_date=new Date(a.item.item_availability.start_date)),a.item.item_availability.end_date&&(a.item.item_availability.end_date=new Date(a.item.item_availability.end_date)),a.getMaxRange=function(){return new Array(_.reduce(a.item.item_availability.available_hours,function(a,b){return _.has(a,"timings")?a.timings.length>b.timings.length?a.timings.length:b.timings.length:a>=b.timings.length?a:b.timings.length}))},a.initializeTiming=function(a,b,c){if(c[a].timings[b].open&&c[a].timings[b].close){var d=new Date;d.setHours(c[a].timings[b].open.hr),d.setMinutes(c[a].timings[b].open.min),d.setSeconds(0),d.setMilliseconds(0);var e=new Date;e.setHours(c[a].timings[b].close.hr),e.setMinutes(c[a].timings[b].close.min),e.setSeconds(0),e.setMilliseconds(0),c[a].timings[b].open.time=d,c[a].timings[b].close.time=e}else{var d=new Date;d.setHours(0),d.setMinutes(1),d.setSeconds(0),d.setMilliseconds(0);var e=new Date;e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),c[a].timings[b]={open:{hr:0,min:1,time:d},close:{hr:0,min:0,time:e}}}},a.updateTiming=function(a,b){b[a].closed?b[a].timings=[]:b[a].timings=[{}]},a.removeTiming=function(a,b,c){c[a].timings.splice(b,1)},a.updateTime=function(a,b,c){var d=c[a].timings[b];d.open.time&&(d.open.hr=d.open.time.getHours(),d.open.min=d.open.time.getMinutes()),d.close.time&&(d.close.hr=d.close.time.getHours(),d.close.min=d.close.time.getMinutes())},a.addNewTiming=function(a,b){b[a].timings.push({})},a.cloneToAllDays=function(a,b){_.each(b,function(c,d){d!==a&&(c.timings=_.cloneDeep(b[a].timings),c.closed=b[a].closed)})},a.validate_timings=function(){var b=e.defer();return _.get(a.item,"item_availability.start_date")&&!_.get(a.item,"item_availability.end_date")||!_.get(a.item,"item_availability.start_date")&&_.get(a.item,"item_availability.end_date")?b.reject('Either specify "both" or "neither" start date and end date.'):a.item.item_availability.start_date&&a.item.item_availability.end_date&&a.item.item_availability.start_date>=a.item.item_availability.end_date?b.reject("Start date must be before end date"):_.get(a.item,"item_availability.days_of_the_week")&&a.item.item_availability.days_of_the_week.length?b.resolve():b.reject("Item must be available on atleast one day"),b.promise},a.resolveChanges=function(){a.validate_timings().then(function(){b.close(a.item)},function(a){d.swal("Validtion error",a,"error")})},a.discardChanges=function(){b.dismiss("Cancel")}}]),angular.module("merchantApp").controller("MenuOptionController",["$scope","$modalInstance","option","is_new","limit_access","option_title","SweetAlert",function(a,b,c,d,e,f,g){a.is_new=d,a.option=c,a.option_title=f,a.limit_access=e,a.resolveOption=function(){a.option.option_value?a.option.option_cost||0===a.option.option_cost?b.close(a.option):g.swal("Validation Error","Option cost required","error"):g.swal("Validation Error","Option name required","error")},a.discardOption=function(){b.dismiss("Cancel")}}]),angular.module("merchantApp").controller("MenuSubCategoryController",["$scope","$modalInstance","sub_category","is_new","SweetAlert",function(a,b,c,d,e){a.is_new=d,a.sub_category=c,a.sub_category_name=["Veg Starter","Non-Veg Starter","Veg Main Course","Non-Veg Main Course"],a.resolveSubCategory=function(){a.sub_category.sub_category_name?b.close(a.sub_category):e.swal("Validation Error","Sub category name cannot be left blank","error")},a.discardSubCategory=function(){b.dismiss("Cancel")}}]),angular.module("merchantApp").controller("MenuSubOptionController",["$scope","$modalInstance","sub_option","is_new","limit_access","SweetAlert",function(a,b,c,d,e,f){a.is_new=d,a.sub_option=c,a.limit_access=e,a.addValuePair=function(){a.sub_option.sub_option_set.push({is_vegetarian:!0})},a.removeValuePair=function(b){a.sub_option.sub_option_set.splice(b,1)},a.resolveSubOption=function(){a.sub_option.sub_option_title?a.sub_option.sub_option_set&&a.sub_option.sub_option_set.length?async.each(a.sub_option.sub_option_set,function(a,b){a.sub_option_value?a.sub_option_cost||0===a.sub_option_cost?b():b("No sub option cost can be left blank"):b("No sub option name can be left blank")},function(c){c?f.swal("Validation Error",c):b.close(a.sub_option)}):f.swal("Validation Error","Please provide atleast one value pair","error"):f.swal("Validation Error","Title required","error")},a.discardSubOption=function(){b.dismiss("Cancel")}}]),angular.module("merchantApp").controller("PickItemController",["$scope","$modalInstance","merchantRESTSvc","SweetAlert",function(a,b,c,d){a.all_menus=[],a.menu_set={},a.category_set={},a.sub_category_set={},a.item_set={},a.option_set={},a.sub_option_sets={},a.addon_sets={},a.menus=[],a.categories=[],a.sub_categories=[],a.items=[],a.options=[],a.sub_options=[],a.addons=[],a.$watchCollection("menu_set",function(b){void 0!==b&&(a.menus=[],a.menus=_.compact(_.map(b,function(a,b){return a?b:!1})),console.log("menus",a.menus))}),a.$watchCollection("category_set",function(b){void 0!==b&&(a.categories=[],a.categories=_.compact(_.map(b,function(a,b){return a?b:!1})),console.log("categories",a.categories))}),a.$watchCollection("sub_category_set",function(b){void 0!==b&&(a.sub_categories=[],a.sub_categories=_.compact(_.map(b,function(a,b){return a?b:!1})),console.log("sub_categories",a.sub_categories))}),a.$watchCollection("item_set",function(b){void 0!==b&&(a.items=[],a.items=_.compact(_.map(b,function(a,b){return a?b:!1})),console.log("items",a.items))}),a.$watchCollection("option_set",function(b){void 0!==b&&(a.options=[],a.options=_.compact(_.map(b,function(a,b){return a?b:!1})),console.log("options",a.options))}),a.$watchCollection("sub_option_sets",function(b){void 0!==b&&(a.sub_options=[],a.sub_options=_.compact(_.map(b,function(a,b){return a?b:!1})),console.log("sub_options",a.sub_options))}),a.$watchCollection("addon_sets",function(b){void 0!==b&&(a.addons=[],a.addons=_.compact(_.map(b,function(a,b){return a?b:!1})),console.log("addons",a.addons))}),a.toggle=function(a){a.toggle()},c.getAllMenus().then(function(b){_.each(b.data,function(b){var c=_.findIndex(a.all_menus,function(a){return a.menu_type===b.menu_type});-1===c?a.all_menus.push(b):_.each(a.all_menus[c].menu_categories,function(d,e){var f=_.findIndex(b.menu_categories,function(a){return a.category_name===d.category_name});if(-1===f)a.all_menus[c].menu_categories.splice(e,1);else{var g=a.all_menus[c].menu_categories[e].sub_categories;_.each(g,function(d,g){var h=_.findIndex(b.menu_categories[f].sub_categories,function(a){return d.sub_category_name===a.sub_category_name});if(-1===h)a.all_menus[c].menu_categories[e].sub_categories.splice(g,1);else{var i=a.all_menus[c].menu_categories[e].sub_categories[g].items;_.each(i,function(c,d){_.findIndex(b.menu_categories[f].sub_categories[h].items,function(a){return a.item_name===c.item_name});-1===d&&a.all_menus[inall_menusdex].menu_categories[e].sub_categories[g].items.splice(d,1)})}})}})})},function(a){console.log(a)}),a.processSelection=function(){var c=[],e=[],f=[],g=[],h=[],i=[],j=[];0===a.menus.length&&0===a.categories.length&&0===a.sub_categories.length&&0===a.items.length&&0===a.options.length&&0===a.sub_options.length&&0===a.addons.length?d.swal("No Selection Made Yet!","Please name atleast one selection","error"):async.each(a.all_menus,function(b,d){if(-1!==a.menus.indexOf(b._id)){c.push(b._id);var k=_.map(b.menu_categories,function(a){return a._id});_.intersection(k,a.categories).length||(e=e.concat(k))}async.each(b.menu_categories,function(d,k){if(-1!==a.categories.indexOf(d._id)){e.push(d._id);var l=_.map(d.sub_categories,function(a){return a._id});_.intersection(l,a.sub_categories).length||(a.sub_categories=a.sub_categories.concat(l),f=f.concat(l)),-1===c.indexOf(b._id)&&c.push(b._id)}async.each(d.sub_categories,function(k,l){if(-1!==a.sub_categories.indexOf(k._id)){f.push(k._id);var m=_.map(k.items,function(a){return a._id});_.intersection(m,a.items).length||(a.items=a.items.concat(m),g=g.concat(m)),-1===c.indexOf(b._id)&&c.push(b._id),-1===e.indexOf(d._id)&&e.push(d._id)}async.each(k.items,function(l,m){if(-1!==a.items.indexOf(l._id)){g.push(l._id);var n=_.map(l.options,function(a){return a._id});_.intersection(n,a.options).length||(a.options=a.options.concat(n),h=h.concat(n)),-1===c.indexOf(b._id)&&c.push(b._id),-1===e.indexOf(d._id)&&e.push(d._id),-1===f.indexOf(k._id)&&f.push(k._id)}async.each(l.options,function(m,n){if(-1!==a.options.indexOf(m._id)){h.push(m);var o=_.flatten(_.map(m.sub_options,function(a){return _.map(a.sub_option_set,function(a){return a._id})})),p=_.flatten(_.map(m.addons,function(a){return _.map(a.addon_set,function(a){return a._id})}));_.intersection(o,a.sub_options).length||(a.sub_options=a.sub_options.concat(o),i=i.concat(o)),_.intersection(p,a.addons).length||(a.addons=a.addons.concat(p),j=j.concat(p)),-1===c.indexOf(b._id)&&c.push(b._id),-1===e.indexOf(d._id)&&e.push(d._id),-1===f.indexOf(k._id)&&f.push(k._id),-1===g.indexOf(l._id)&&g.push(l._id)}async.parallel({sub_options:function(b){async.each(l.sub_options,function(b,c){if(-1!==h.indexOf(m._id)){var d=_.map(b.sub_option_set,function(a){return a._id}),e=_.intersection(d,a.sub_options);e.length?(i=i.concat(e),c()):(i=i.concat(d),c())}else c()},function(){b()})},addons:function(b){async.each(l.addons,function(b,c){if(-1!==h.indexOf(m._id)){var d=_.map(j.addon_set,function(a){return a._id}),e=_.intersection(d,a.addons);e.length?(j=j.concat(e),c()):(j=j.concat(d),c())}else c()},function(){b()})}},function(){n()})},function(){m()})},function(){l()})},function(){k()})},function(){d()})},function(){console.log({menus:c,categories:e,sub_categories:f,items:g,options:h,sub_options:i,addons:j}),b.close({menus:c,categories:e,sub_categories:f,items:g,options:h,sub_options:i,addons:j})})},a.cancelSelection=function(){b.dismiss("cancel")}}]),angular.module("merchantApp").controller("OrderViewController",["$scope","$modalInstance","order","merchantRESTSvc","SweetAlert",function(a,b,c,d,e){console.log("order",c),a.order=c,a.getItemPrice=function(a){var b=0;return a.option&&a.option._id?((a.option.option_is_addon===!0||a.option_price_is_additive===!0)&&(b+=a.item_cost),b+=a.option.option_cost,_.each(a.sub_options,function(a){b+=a.sub_option_set[0].sub_option_cost}),_.each(a.addons,function(a){_.each(a.addon_set,function(a){b+=a.addon_cost})}),b):a.item_price},a.getItemTotal=function(){var a=0;return _.each(c.items,function(b){if(b.option&&b.option._id){var c=b.option.option_cost;(b.option_is_addon===!0||b.option_price_is_additive===!0)&&(c+=b.item_cost),_.each(b.sub_options,function(a){c+=a.sub_option_set[0].sub_option_cost}),_.each(b.addons,function(a){_.each(a.addon_set,function(a){c+=a.addon_cost})}),a+=c}else a+=b.item_cost}),a},a.initEndTime=function(){"accepted"===a.order.order_status&&(a.order.end_time=new Date(a.order.order_date).getTime()+60*a.order.estimate_time*1e3)},a.acceptOrder=function(){if(a.order&&a.order.estimate_time){var b={};b.update_type="accept",b.estimate_time=a.order.estimate_time,d.updateOrder(b).then(function(b){console.log(b),e.swal("Update successful","Order accepted successfully","success"),a.order.order_status="accepted",a.initEndTime()},function(a){console.log(a)})}else e.swal("Validation error","Please provide valid estimate delivery time","error")},a.rejectOrder=function(){var b={};b.update_type="reject",d.updateOrder(b).then(function(b){console.log(b),e.swal("Update successful","Order rejected successfully","info"),a.order.order_status="rejected"},function(a){console.log(a)})},a.dispatchOrder=function(){var b={};b.update_type="dispatch",d.updateOrder(b).then(function(b){console.log(b),e.swal("Update successful",'Order status updated to "DISPATCHED"',"success"),a.order.order_status="dispatched"},function(a){console.log(a)})}}]),angular.module("merchantApp").controller("PanelVoucherController",["$scope","$modalInstance","vouchers","outlet","SweetAlert","merchantRESTSvc",function(a,b,c,d,e,f){a.today=new Date,a.THREE_HOURS=new Date(Date.now()-108e5),a.vouchers=c,_.each(a.vouchers,function(a){a.lapse_date&&(a.lapse_date=new Date(a.lapse_date)),a.expiry_date&&(a.expiry_date=new Date(a.expiry_date)),a.issued_at&&(a.issued_at=new Date(a.issued_at))}),a.redeemUserCoupon=function(a){f.redeemUserCoupon(d,a).then(function(a){e.swal({title:"Coupon redeemed",type:"success",text:a.message},function(){b.close()})},function(a){e.swal({title:"ERROR",text:a.message?a.message:"Something went wrong",type:"error"},function(){b.dismiss("cancel")})})}}]),angular.module("merchantApp").controller("OfferCreateController",["$scope","merchantRESTSvc","$q","SweetAlert","$state","$stateParams","$filter","$modal","WizardHandler","$rootScope",function(a,b,c,d,e,f,g,h,i,j){a.today=new Date,a.today.setMilliseconds(0),a.today.setSeconds(0),a.today.setMinutes(0),a.today.setHours(0),a.max_date=new Date(a.today.getTime()+10368e6),a.max_date.setMilliseconds(999),a.max_date.setSeconds(59),a.max_date.setMinutes(59),a.max_date.setHours(23),a.days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],a.offer_types={checkin:"Checkin Offer",offer:"Promoted offer"},a.delivery_reward_types={buyxgety:"Buy X Get Y",free:"Free",flatoff:"Flat Off",discount:"Discount"},a.generic_reward_types={buyonegetone:"Buy One Get One",discount:"Discount",flatoff:"Flat Off",free:"Free",happyhours:"Happy Hours",reduced:"Reduced Price",custom:"Custom",unlimited:"Unlimited",onlyhappyhours:"Only Happy Hours",combo:"Combo",buffet:"Buffet"},a.event_matches={"on every":"On Every",after:"After","on only":"On Only"},a.offer={offer_status:"active",offer_type:"",user_sourced:!1,offer_start_date:_.clone(a.today),offer_end_date:new Date(a.today.getTime()+5184e6),rule:{},actions:{reward:{reward_meta:{},reward_hours:{monday:{closed:!1,timings:[{}]},tuesday:{closed:!1,timings:[{}]},wednesday:{closed:!1,timings:[{}]},thursday:{closed:!1,timings:[{}]},friday:{closed:!1,timings:[{}]},saturday:{closed:!1,timings:[{}]},sunday:{closed:!1,timings:[{}]}},applicability:{dine_in:!1,delivery:!1}}},offer_items:{all:!0}},a.menus=[],b.getAllMenus().then(function(b){_.each(b.data,function(b){a.outlet_id?a.outlet_id===b.outlet._id&&a.menus.push(b):(a.outlet_id=b.outlet._id,a.menus.push(b))})}),b.getOutlets().then(function(b){a.outlets=_.indexBy(b.data,"_id"),a.filtered_outlets=_.cloneDeep(a.outlets)},function(b){console.log(b),d.swal("Error getting outlets",b.message?b.message:"Something went wrong","error"),a.outlets={},a.filtered_outlets=_.cloneDeep(a.outlets)}),a.$watchCollection("offer.offer_type",function(b,c){b&&"offer"===b&&(Object.keys(a.offer.rule).length&&(a.offer.rule={}),a.offer.offer_cost||(a.offer.offer_cost="100"))}),a.$watchCollection("offer.rule",function(b,c){var d=g("ordinal");b.event_match!==c.event_match&&void 0!==c.event_match?(a.offer.rule.friendly_text="",a.offer.rule={event_match:b.event_match}):b.event_match&&("on every"===b.event_match&&b.event_count&&(b.event_start||0===b.event_start)&&b.event_end?b.friendly_text="Applicable on every "+d(b.event_count)+" checkin from "+d(b.event_start)+" to "+d(b.event_end)+" checkin.":"after"===b.event_match&&(b.event_start||0===b.event_start)&&b.event_end?b.friendly_text="Applicable on every checkin from "+d(b.event_start)+" to "+d(b.event_end)+" checkin.":"on only"!==b.event_match||!b.event_count&&0!==b.event_count?b.friendly_text="":b.friendly_text="Applicable on the "+d(b.event_count)+" checkin.")}),a.chooseItem=function(b){var c=h.open({animation:!0,templateUrl:"templates/partials/offer.pick_item.tmpl.html",controller:"PickItemController",size:"md"});c.result.then(function(c){"buyxgety_2"!==b&&(a.offer.offer_items=_.clone(c),a.offer.offer_items.all=!1),"buyxgety_2"===b&&(a.offer.actions.reward.reward_meta.paid_item=_.clone(c))})},a.getRange=function(a){return new Array(a)},a.removeOutlet=function(b){a.offer.offer_outlets&&a.offer.offer_outlets.splice(b,1)},a.initalizeTiming=function(a,b,c){if(!c[a].timings[b].open||!c[a].timings[b].close){var d=new Date;j.isPaying?(d.setHours(9),d.setMinutes(0),d.setSeconds(0),d.setMilliseconds(0)):(d.setHours(0),d.setMinutes(1),d.setSeconds(0),d.setMilliseconds(0));var e=new Date;j.isPaying?(e.setHours(21),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0)):(e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0)),j.isPaying?c[a].timings[b]={open:{hr:9,min:0,time:d},close:{hr:21,min:0,time:e}}:c[a].timings[b]={open:{hr:0,min:1,time:d},close:{hr:0,min:0,time:e}}}},a.updateTimingSet=function(b,c){c[b].closed?c[b].timings=[]:(c[b].timings=[{}],a.initalizeTiming(b,0,c))},a.addNewTiming=function(a,b){b[a].timings.push({})},a.updateTime=function(a,b,c){var d=c[a].timings[b];d.open.time&&(d.open.hr=d.open.time.getHours(),d.open.min=d.open.time.getMinutes()),d.close.time&&(d.close.hr=d.close.time.getHours(),d.close.min=d.close.time.getMinutes())},a.removeTiming=function(a,b,c){c[a].timings.splice(b,1)},a.cloneToAllDays=function(a,b){_.each(b,function(c,d){d!==a&&(c.timings=_.cloneDeep(b[a].timings),c.closed=b[a].closed)})},a.addOutlet=function(b){b&&(a.offer.offer_outlets?-1===a.offer.offer_outlets.indexOf(b)&&a.offer.offer_outlets.push(b):(a.offer.offer_outlets=[b],a.cloneTimings({_id:b})))},a.cloneTimings=function(b){b._id&&(a.offer.actions.reward.reward_hours=_.indexBy(_.map(Object.keys(a.outlets[b._id].business_hours),function(c){var d=_.map(a.outlets[b._id].business_hours[c].timings,function(a){delete a._id;var b=new Date;return b.setSeconds(0),b.setMilliseconds(0),a.open.time=_.clone(b),a.open.time.setMinutes(a.open.min),a.open.time.setHours(a.open.hr),a.close.time=_.clone(b),a.close.time.setMinutes(a.close.min),a.close.time.setHours(a.close.hr),_.cloneDeep(a)});return{day:c,timings:d,closed:a.outlets[b._id].business_hours[c].closed}}),"day"),b._id="")},a.getMaxRange=function(){return new Array(_.reduce(a.offer.actions.reward.reward_hours,function(a,b){return _.has(a,"timings")?a.timings.length>b.timings.length?a.timings.length:b.timings.length:a>=b.timings.length?a:b.timings.length}))},a.createOffer=function(){b.createOffer(a.offer).then(function(a){d.swal({title:"Offer created successfully",type:"success",showCancelButton:!1,confirmButtonText:"Continue"},function(){e.go("^.offers_manage",{},{reload:!0})})},function(a){var b=a.message?a.message:"Something went wrong";d.swal("Service error",b,"error")})},a.filterOutlets=function(){a.filtered_outlets=_.indexBy(_.filter(a.outlets,function(b){return a.offer.actions.reward.applicability.delivery?b.attributes.home_delivery:!0}),"_id")},a.backToStart=function(){i.wizard().goTo(0)},a.scrollToTop=function(){$("document").ready(function(){$(window).scrollTop(0)})},a.validateStep1=function(){var b=c.defer(),e=function(c){a.formFailure=!0,d.swal("Validation Error",c,"error"),b.reject()};return a.validateOfferType().then(function(){a.validateOfferRules().then(function(){a.validateRewardInfo().then(function(){a.validateRewardDetails().then(function(){a.scrollToTop(),a.formFailure=!1,b.resolve(!0)},e)},e)},e)},e),b.promise},a.validateStep2=function(){var b=c.defer(),e=function(c){a.formFailure=!0,d.swal("Validation Error",c,"error"),b.reject()};return a.validateOfferTerms().then(function(){a.validateOfferTimings().then(function(){a.validateAgainstOutlets().then(function(){a.validateOfferValidity().then(function(){a.scrollToTop(),a.formFailure=!1,b.resolve(!0)},e)},e)},e)},e),b.promise},a.validateOfferType=function(){var b=c.defer();return a.offer.offer_type?!a.offer.user_sourced||a.offer.offer_user_source&&/^[a-zA-Z0-9]{24}$/i.test(a.offer.offer_user_source)?b.resolve(!0):b.reject("Valid user ID required for user sourced offers"):b.reject("Offer type must be selected"),b.promise},a.validateOfferRules=function(){var b=c.defer();return"checkin"!==a.offer.offer_type?b.resolve(!0):a.offer.rule.event_match?"on every"===a.offer.rule.event_match?a.offer.rule.event_count?a.offer.rule.event_start||0===a.offer.rule.event_start?a.offer.rule.event_end?a.offer.rule.event_count>a.offer.rule.event_end-a.offer.rule.event_start||a.offer.rule.event_start>=a.offer.rule.event_end?b.reject("Atleast two checkins must be possible from start to end checkin"):b.resolve(!0):b.reject("Valid end checkin required"):b.reject("Valid start checkin required"):b.reject("Valid checkin repeat required"):"after"===a.offer.rule.event_match?a.offer.rule.event_start||0===a.offer.rule.event_start?a.offer.rule.event_end?a.offer.rule.event_end<=a.offer.rule.event_start?b.reject("Offer rule end checkin must be after start checkin count"):b.resolve(!0):b.reject("Valid offer end checkin count required"):b.reject("Valid offer start checkin count required"):"on only"===a.offer.rule.event_match&&(a.offer.rule.event_count?b.resolve(!0):b.reject("Valid checkin number required")):b.reject("Offer criteria required"),b.promise},a.validateRewardDetails=function(){var b=c.defer();return a.offer.actions.reward.applicability.delivery||a.offer.actions.reward.applicability.dine_in?a.offer.actions.reward.reward_meta.reward_type?"buyxgety"===a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.reward_meta.paid_item?a.offer.offer_items.menus&&a.offer.offer_items.menus.length?b.resolve(!0):b.reject('Buy X Get Y requires "FREE ITEM"'):b.reject('Buy X Get Y requires "PAID ITEM"'):"free"===a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.applicability.delivery?a.offer.offer_items&&a.offer.offer_items.menus&&a.offer.offer_items.menus.length?b.resolve(!0):b.reject('Please choose the "FREE ITEM"'):a.offer.actions.reward.reward_meta.title?a.offer.actions.reward.reward_meta._with?b.resolve(!0):b.reject("Free offer requires conditions"):b.reject("Free offer requires free item name"):"flatoff"===a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.applicability.delivery?a.offer.actions.reward.reward_meta.off?a.offer.actions.reward.reward_meta.spend?a.offer.offer_items.all||a.offer.offer_items.menus&&a.offer.offer_items.menus.length?b.resolve(!0):b.reject("Please choose the items first"):b.reject("Flatoff required minimum spend."):b.reject("Flatoff required off amount."):a.offer.actions.reward.reward_meta.off?a.offer.actions.reward.reward_meta.spend?b.resolve(!0):b.reject("Flatoff required minimum spend"):b.reject("Flatoff required off amount"):"discount"===a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.applicability.delivery?a.offer.actions.reward.reward_meta.percent?a.offer.actions.reward.reward_meta.max?a.offer.offer_items.all||a.offer.offer_items.menus&&a.offer.offer_items.menus.length?b.resolve(!0):b.reject("Please choose the items first"):b.reject("Max discount amount required"):b.reject("Valid discount percentage required"):a.offer.actions.reward.reward_meta.percent?a.offer.actions.reward.reward_meta.max?b.resolve(!0):b.reject("Discouut requires maximum discount amount"):b.reject("Discount requires valid disount percentage"):"buyonegetone"===a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.reward_meta.bogo?b.resolve(!0):b.reject("'Buy One Get One' requires item names"):"happyhours"==a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.reward_meta.extension?b.resolve(!0):b.reject("'Happy hours' offer requires extension duration (in hrs.)"):"reduced"==a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.reward_meta.what?a.offer.actions.reward.reward_meta.worth?a.offer.actions.reward.reward_meta.for_what?b.resolve(!0):b.reject("Reduced offer requires deal price"):b.reject("Reduced offer requires actual worth"):b.reject("Reduced offer requires item info"):"custom"==a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.reward_meta.title?b.resolve(!0):b.reject("Custom offer requires offer details"):"unlimited"==a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.reward_meta.item?a.offer.actions.reward.reward_meta.conditions?b.resolve(!0):b.reject("Unlimited offer requires offer criteria"):b.reject("Unlimited offer requires item name"):"onlyhappyhours"==a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.reward_meta.title?a.offer.actions.reward.reward_meta.conditions?b.resolve(!0):b.reject("'Only happy hours' offer requires deal items"):b.reject("'Only happy hours' offer requires deal info"):"combo"==a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.reward_meta.items?a.offer.actions.reward.reward_meta._for?b.resolve(!0):b.reject("Combo offer requires deal price"):b.reject("Combo offer requires deal items"):"buffet"==a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.reward_meta.title?a.offer.actions.reward.reward_meta.cost?b.resolve(!0):b.reject("Buffet offer requires deal price"):b.reject("Buffet offer requires deal info"):b.reject("Valid reward type required"):b.reject("Choose a reward type"):b.reject("Offer cannot be invalid for both dine-in and delivery"),b.promise},a.validateRewardInfo=function(){var b=c.defer();return a.offer.actions.reward.header?a.offer.actions.reward.line1?b.resolve(!0):b.reject("Line 1 cannot be left blank"):b.reject("Header cannot be left blank"),b.promise},a.validateOfferTerms=function(){var b=c.defer();return a.offer.minimum_bill_value||0===a.offer.minimum_bill_value?a.offer.offer_lapse_days||"checkin"!==a.offer.offer_type?a.offer.offer_valid_days||"checkin"!==a.offer.offer_type?a.offer.offer_cost||"offer"!==a.offer.offer_type?b.resolve(!0):b.reject("Offer cost required"):b.reject("Offer expiration duration required"):b.reject("Offer lapse duration required"):b.reject("Minimum bill value required"),b.promise},a.validateOfferTimings=function(){var b=c.defer();return a.offer.offer_outlets&&a.offer.offer_outlets.length?async.each(a.days,function(b,c){var d=a.offer.actions.reward.reward_hours[b];d.closed?c():async.each(d.timings,function(c,e){!c.open.hr&&0!==c.open.hr||!c.open.min&&0!==c.open.min||!c.close.hr&&0!==c.close.hr||!c.close.min&&0!==c.close.min?(a.errorDay=b,e("One or more offer timings are invalid for "+b.toUpperCase())):async.each(d.timings,function(d,e){if(!d.open.hr&&0!==d.open.hr||!d.open.min&&0!==d.open.min||!d.close.hr&&0!==d.close.hr||!d.close.min&&0!==d.close.min)a.errorDay=b,e("One or more offer timings are invalid for "+b.toUpperCase());else{var f=60*c.open.hr+c.open.min,g=60*c.close.hr+c.close.min,h=60*d.open.hr+d.open.min,i=60*d.close.hr+d.close.min;c===d?e():i>=f&&g>=i||h>=f&&g>=h||g>=h&&i>=g?(a.errorDay=b,e("One or more offer timings invalid for "+b.toUpperCase())):e()}},function(a){e(a)})},function(a){c(a)})},function(a){a?b.reject(a):b.resolve(!0)}):b.reject("Select atleast one outlet"),b.promise},a.validateAgainstOutlets=function(){var b=c.defer();return async.each(a.days,function(b,c){var d=a.offer.actions.reward.reward_hours[b];d.closed?c():async.each(d.timings,function(c,d){var e=60*c.open.hr+c.open.min,f=60*c.close.hr+c.close.min;async.each(a.offer.offer_outlets,function(c,d){var g=a.outlets[c],h=g.business_hours[b];e>=f&&(f+=1440),h.closed?(a.errorDay=b,d("Offer available on "+b.toUpperCase()+" despite outlet "+g.basics.name+" being closed.")):async.each(h.timings,function(a,b){var c=60*a.open.hr+a.open.min,d=60*a.close.hr+a.close.min;c>=d&&(d+=1440),e>=c&&d>=f?b("found"):b()},function(a){d(a)})},function(c){"found"===c?d():c?d(c):(a.errorDay=b,d("Offer available on "+b.toUpperCase()+" outside the timings for all outlets."))})},function(a){c(a)})},function(a){a?b.reject(a):b.resolve(!0)}),b.promise},a.validateOfferValidity=function(){var b=c.defer();return!a.offer.offer_start_date||a.offer.offer_start_date>a.max_date?b.reject("Offer required valid start date."):!a.offer.offer_end_date||a.offer.offer_end_date>a.max_date?b.reject("Offer required valid end date."):!a.offer.offer_start_date>=a.offer.offer_end_date?b.reject("Offer start date cannot be before or same as offer end date"):a.offer.offer_outlets&&a.offer.offer_outlets.length?b.resolve(!0):b.reject("Please select atleast one outlet"),b.promise}}]),angular.module("merchantApp").controller("OfferEditController",["$scope","merchantRESTSvc","$q","SweetAlert","$state","$stateParams","$filter","$modal","WizardHandler","$rootScope",function(a,b,c,d,e,f,g,h,i,j){a.today=new Date,a.today.setMilliseconds(0),a.today.setSeconds(0),a.today.setMinutes(0),a.today.setHours(0),a.max_date=new Date(a.today.getTime()+10368e6),a.max_date.setMilliseconds(999),a.max_date.setSeconds(59),a.max_date.setMinutes(59),a.max_date.setHours(23),a.days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],a.offer_types={checkin:"Checkin Offer",offer:"Promoted offer"},a.delivery_reward_types={buyxgety:"Buy X Get Y",free:"Free",flatoff:"Flat Off",discount:"Discount"},a.generic_reward_types={buyonegetone:"Buy One Get One",discount:"Discount",flatoff:"Flat Off",free:"Free",happyhours:"Happy Hours",reduced:"Reduced Price",custom:"Custom",unlimited:"Unlimited",onlyhappyhours:"Only Happy Hours",combo:"Combo",buffet:"Buffet"},a.event_matches={"on every":"On Every",after:"After","on only":"On Only"},a.offer={offer_status:"draft",offer_type:"",user_sourced:!1,offer_start_date:_.clone(a.today),offer_end_date:new Date(a.today.getTime()+5184e6),rule:{},actions:{reward:{reward_meta:{},reward_hours:{monday:{closed:!1,timings:[{}]},tuesday:{closed:!1,timings:[{}]},wednesday:{closed:!1,timings:[{}]},thursday:{closed:!1,timings:[{}]},friday:{closed:!1,timings:[{}]},saturday:{closed:!1,timings:[{}]},sunday:{closed:!1,timings:[{}]}},applicability:{dine_in:!1,delivery:!1}}},offer_items:{all:!0}},a.menus=[],b.getAllMenus().then(function(b){_.each(b.data,function(b){a.outlet_id?a.outlet_id===b.outlet._id&&a.menus.push(b):(a.outlet_id=b.outlet._id,a.menus.push(b))})}),b.getOutlets().then(function(b){a.outlets=_.indexBy(b.data,"_id"),a.filtered_outlets=_.cloneDeep(a.outlets)},function(b){console.log(b),
d.swal("Error getting outlets",b.message?b.message:"Something went wrong","error"),a.outlets={},a.filtered_outlets=_.cloneDeep(a.outlets)}),b.getOffer(f.offer_id).then(function(b){b.data.offer_cost&&(b.data.offer_cost=b.data.offer_cost.toString()),a.offer=_.merge(a.offer,b.data),_.each(a.offer.actions.reward.reward_hours,function(a){if(!a.is_closed){var b=new Date;b.setSeconds(0),b.setMilliseconds(0),_.each(a.timings,function(a){a.open.time=_.clone(b),a.open.time.setHours(a.open.hr),a.open.time.setMinutes(a.open.min),a.close.time=_.clone(b),a.close.time.setHours(a.close.hr),a.close.time.setMinutes(a.close.min)})}})},function(a){console.log("erro",a)}),a.$watchCollection("offer.offer_type",function(b,c){b&&"offer"===b&&(Object.keys(a.offer.rule).length&&(a.offer.rule={}),a.offer.offer_cost||(a.offer.offer_cost="100"))}),a.$watchCollection("offer.rule",function(b,c){var d=g("ordinal");b.event_match!==c.event_match&&void 0!==c.event_match?(a.offer.rule.friendly_text="",a.offer.rule={event_match:b.event_match}):b.event_match&&("on every"===b.event_match&&b.event_count&&(b.event_start||0===b.event_start)&&b.event_end?b.friendly_text="Applicable on every "+d(b.event_count)+" checkin from "+d(b.event_start)+" to "+d(b.event_end)+" checkin.":"after"===b.event_match&&(b.event_start||0===b.event_start)&&b.event_end?b.friendly_text="Applicable on every checkin from "+d(b.event_start)+" to "+d(b.event_end)+" checkin.":"on only"!==b.event_match||!b.event_count&&0!==b.event_count?b.friendly_text="":b.friendly_text="Applicable on the "+d(b.event_count)+" checkin.")}),a.chooseItem=function(b){var c=h.open({animation:!0,templateUrl:"templates/partials/offer.pick_item.tmpl.html",controller:"PickItemController",size:"md"});c.result.then(function(c){"buyxgety_2"!==b&&(a.offer.offer_items=_.clone(c),a.offer.offer_items.all=!1),"buyxgety_2"===b&&(a.offer.actions.reward.reward_meta.paid_item=_.clone(c))})},a.removeOutlet=function(b){a.offer.offer_outlets&&a.offer.offer_outlets.splice(b,1)},a.addOutlet=function(b){b&&(a.offer.offer_outlets?-1===a.offer.offer_outlets.indexOf(b)&&a.offer.offer_outlets.push(b):(a.offer.offer_outlets=[b],a.cloneTimings({_id:b})))},a.initalizeTiming=function(a,b,c){if(!c[a].timings[b].open||!c[a].timings[b].close){var d=new Date;j.isPaying?(d.setHours(9),d.setMinutes(0),d.setSeconds(0),d.setMilliseconds(0)):(d.setHours(0),d.setMinutes(1),d.setSeconds(0),d.setMilliseconds(0));var e=new Date;j.isPaying?(e.setHours(21),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0)):(e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0)),j.isPaying?c[a].timings[b]={open:{hr:9,min:0,time:d},close:{hr:21,min:0,time:e}}:c[a].timings[b]={open:{hr:0,min:1,time:d},close:{hr:0,min:0,time:e}}}},a.updateTimingSet=function(b,c){c[b].closed?c[b].timings=[]:(c[b].timings=[{}],a.initalizeTiming(b,0,c))},a.addNewTiming=function(a,b){b[a].timings.push({})},a.updateTime=function(a,b,c){var d=c[a].timings[b];d.open.time&&(d.open.hr=d.open.time.getHours(),d.open.min=d.open.time.getMinutes()),d.close.time&&(d.close.hr=d.close.time.getHours(),d.close.min=d.close.time.getMinutes())},a.removeTiming=function(a,b,c){c[a].timings.splice(b,1)},a.cloneToAllDays=function(a,b){_.each(b,function(c,d){d!==a&&(c.timings=_.cloneDeep(b[a].timings),c.closed=b[a].closed)})},a.cloneTimings=function(b){b._id&&(a.offer.actions.reward.reward_hours=_.indexBy(_.map(Object.keys(a.outlets[b._id].business_hours),function(c){var d=_.map(a.outlets[b._id].business_hours[c].timings,function(a){delete a._id;var b=new Date;return b.setSeconds(0),b.setMilliseconds(0),a.open.time=_.clone(b),a.open.time.setMinutes(a.open.min),a.open.time.setHours(a.open.hr),a.close.time=_.clone(b),a.close.time.setMinutes(a.close.min),a.close.time.setHours(a.close.hr),_.cloneDeep(a)});return{day:c,timings:d,closed:a.outlets[b._id].business_hours[c].closed}}),"day"),b._id="")},a.getMaxRange=function(){return new Array(_.reduce(a.offer.actions.reward.reward_hours,function(a,b){return _.has(a,"timings")?a.timings.length>b.timings.length?a.timings.length:b.timings.length:a>=b.timings.length?a:b.timings.length}))},a.updateOffer=function(){b.updateOffer(a.offer).then(function(a){d.swal({title:"Offer updated successfully",type:"success",showCancelButton:!1,confirmButtonText:"Continue"},function(){e.go("^.offers_manage",{},{reload:!0})})},function(a){var b=a.message?a.message:"Something went wrong";d.swal("Service error",b,"error")})},a.filterOutlets=function(){a.filtered_outlets=_.indexBy(_.filter(a.outlets,function(b){return console.log("delivery",a.offer.actions.reward.applicability.delivery),a.offer.actions.reward.applicability.delivery?b.attributes.home_delivery:!0}),"_id"),console.log(a.filtered_outlets)},a.backToStart=function(){i.wizard().goTo(0)},a.scrollToTop=function(){$("document").ready(function(){$(window).scrollTop(0)})},a.validateStep1=function(){var b=c.defer(),e=function(c){a.formFailure=!0,d.swal("Validation Error",c,"error"),b.reject()};return a.validateOfferType().then(function(){a.validateOfferRules().then(function(){a.validateRewardInfo().then(function(){a.validateRewardDetails().then(function(){a.scrollToTop(),a.formFailure=!1,b.resolve(!0)},e)},e)},e)},e),b.promise},a.validateStep2=function(){var b=c.defer(),e=function(c){a.formFailure=!0,d.swal("Validation Error",c,"error"),b.reject()};return a.validateOfferTerms().then(function(){a.validateOfferTimings().then(function(){a.validateAgainstOutlets().then(function(){a.validateOfferValidity().then(function(){a.scrollToTop(),a.formFailure=!1,b.resolve(!0)},e)},e)},e)},e),b.promise},a.validateOfferType=function(){var b=c.defer();return a.offer.offer_type?!a.offer.user_sourced||a.offer.offer_user_source&&/^[a-zA-Z0-9]{24}$/i.test(a.offer.offer_user_source)?b.resolve(!0):b.reject("Valid user ID required for user sourced offers"):b.reject("Offer type must be selected"),b.promise},a.validateOfferRules=function(){var b=c.defer();return"checkin"!==a.offer.offer_type?b.resolve(!0):a.offer.rule.event_match?"on every"===a.offer.rule.event_match?a.offer.rule.event_count?a.offer.rule.event_start||0===a.offer.rule.event_start?a.offer.rule.event_end?a.offer.rule.event_count>a.offer.rule.event_end-a.offer.rule.event_start||a.offer.rule.event_start>=a.offer.rule.event_end?b.reject("Atleast two checkins must be possible from start to end checkin"):b.resolve(!0):b.reject("Valid end checkin required"):b.reject("Valid start checkin required"):b.reject("Valid checkin repeat required"):"after"===a.offer.rule.event_match?a.offer.rule.event_start||0===a.offer.rule.event_start?a.offer.rule.event_end?a.offer.rule.event_end<=a.offer.rule.event_start?b.reject("Offer rule end checkin must be after start checkin count"):b.resolve(!0):b.reject("Valid offer end checkin count required"):b.reject("Valid offer start checkin count required"):"on only"===a.offer.rule.event_match&&(a.offer.rule.event_count?b.resolve(!0):b.reject("Valid checkin number required")):b.reject("Offer criteria required"),b.promise},a.validateRewardDetails=function(){var b=c.defer();return a.offer.actions.reward.applicability.delivery||a.offer.actions.reward.applicability.dine_in?a.offer.actions.reward.reward_meta.reward_type?"buyxgety"===a.offer.actions.reward.reward_meta.reward_type?a.offer.offer_items.menus&&a.offer.offer_items.menus.length?a.offer.actions.reward.reward_meta.paid_item?b.resolve(!0):b.reject('Buy X Get Y requires "PAID ITEM"'):b.reject('Buy X Get Y requires "FREE ITEM"'):"free"===a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.applicability.delivery?a.offer.offer_items&&a.offer.offer_items.menus&&a.offer.offer_items.menus.length?b.resolve(!0):b.reject('Please choose the "FREE ITEM"'):a.offer.actions.reward.reward_meta.title?a.offer.actions.reward.reward_meta._with?b.resolve(!0):b.reject("Free offer requires conditions"):b.reject("Free offer requires free item name"):"flatoff"===a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.applicability.delivery?a.offer.actions.reward.reward_meta.off?a.offer.actions.reward.reward_meta.spend?a.offer.offer_items.all||a.offer.offer_items.menus&&a.offer.offer_items.menus.length?b.resolve(!0):b.reject("Please choose the items first"):b.reject("Flatoff required minimum spend."):b.reject("Flatoff required off amount."):a.offer.actions.reward.reward_meta.off?a.offer.actions.reward.reward_meta.spend?b.resolve(!0):b.reject("Flatoff required minimum spend"):b.reject("Flatoff required off amount"):"discount"===a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.applicability.delivery?a.offer.actions.reward.reward_meta.percent?a.offer.actions.reward.reward_meta.max?a.offer.offer_items.all||a.offer.offer_items.menus&&a.offer.offer_items.menus.length?b.resolve(!0):b.reject("Please choose the items first"):b.reject("Max discount amount required"):b.reject("Valid discount percentage required"):a.offer.actions.reward.reward_meta.percent?a.offer.actions.reward.reward_meta.max?b.resolve(!0):b.reject("Discouut requires maximum discount amount"):b.reject("Discount requires valid disount percentage"):"buyonegetone"===a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.reward_meta.bogo?b.resolve(!0):b.reject("'Buy One Get One' requires item names"):"happyhours"==a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.reward_meta.extension?b.resolve(!0):b.reject("'Happy hours' offer requires extension duration (in hrs.)"):"reduced"==a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.reward_meta.what?a.offer.actions.reward.reward_meta.worth?a.offer.actions.reward.reward_meta.for_what?b.resolve(!0):b.reject("Reduced offer requires deal price"):b.reject("Reduced offer requires actual worth"):b.reject("Reduced offer requires item info"):"custom"==a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.reward_meta.title?b.resolve(!0):b.reject("Custom offer requires offer details"):"unlimited"==a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.reward_meta.item?a.offer.actions.reward.reward_meta.conditions?b.resolve(!0):b.reject("Unlimited offer requires offer criteria"):b.reject("Unlimited offer requires item name"):"onlyhappyhours"==a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.reward_meta.title?a.offer.actions.reward.reward_meta.conditions?b.resolve(!0):b.reject("'Only happy hours' offer requires deal items"):b.reject("'Only happy hours' offer requires deal info"):"combo"==a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.reward_meta.items?a.offer.actions.reward.reward_meta._for?b.resolve(!0):b.reject("Combo offer requires deal price"):b.reject("Combo offer requires deal items"):"buffet"==a.offer.actions.reward.reward_meta.reward_type?a.offer.actions.reward.reward_meta.title?a.offer.actions.reward.reward_meta.cost?b.resolve(!0):b.reject("Buffet offer requires deal price"):b.reject("Buffet offer requires deal info"):b.reject("Valid reward type required"):b.reject("Choose a reward type"):b.reject("Offer cannot be invalid for both dine-in and delivery"),b.promise},a.validateRewardInfo=function(){var b=c.defer();return a.offer.actions.reward.header?a.offer.actions.reward.line1?b.resolve(!0):b.reject("Line 1 cannot be left blank"):b.reject("Header cannot be left blank"),b.promise},a.validateOfferTerms=function(){var b=c.defer();return a.offer.minimum_bill_value||0===a.offer.minimum_bill_value?a.offer.offer_lapse_days||"checkin"!==a.offer.offer_type?a.offer.offer_valid_days||"checkin"!==a.offer.offer_type?a.offer.offer_cost||"offer"!==a.offer.offer_type?b.resolve(!0):b.reject("Offer cost required"):b.reject("Offer expiration duration required"):b.reject("Offer lapse duration required"):b.reject("Minimum bill value required"),b.promise},a.validateOfferTimings=function(){var b=c.defer();return a.offer.offer_outlets&&a.offer.offer_outlets.length?async.each(a.days,function(b,c){var d=a.offer.actions.reward.reward_hours[b];d.closed?c():async.each(d.timings,function(a,c){!a.open.hr&&0!==a.open.hr||!a.open.min&&0!==a.open.min||!a.close.hr&&0!==a.close.hr||!a.close.min&&0!==a.close.min?c("One or more offer timings are invalid for "+b.toUpperCase()):async.each(d.timings,function(c,d){if(!c.open.hr&&0!==c.open.hr||!c.open.min&&0!==c.open.min||!c.close.hr&&0!==c.close.hr||!c.close.min&&0!==c.close.min)d("One or more offer timings are invalid for "+b.toUpperCase());else{var e=60*a.open.hr+a.open.min,f=60*a.close.hr+a.close.min,g=60*c.open.hr+c.open.min,h=60*c.close.hr+c.close.min;a===c?d():h>=e&&f>=h||g>=e&&f>=g||f>=g&&h>=f?d("One or more offer timings invalid for "+b.toUpperCase()):d()}},function(a){c(a)})},function(a){c(a)})},function(a){a?b.reject(a):b.resolve(!0)}):b.reject("Select atleast one outlet"),b.promise},a.validateAgainstOutlets=function(){var b=c.defer();return async.each(a.days,function(b,c){var d=a.offer.actions.reward.reward_hours[b];d.closed?c():async.each(d.timings,function(c,d){var e=60*c.open.hr+c.open.min,f=60*c.close.hr+c.close.min;async.each(a.offer.offer_outlets,function(c,d){var g=a.outlets[c],h=g.business_hours[b];e>=f&&(f+=1440),h.closed?d("Offer available on "+b.toUpperCase()+" despite outlet "+g.basics.name+" being closed."):async.each(h.timings,function(a,b){var c=60*a.open.hr+a.open.min,d=60*a.close.hr+a.close.min;c>=d&&(d+=1440),e>=c&&d>=f?b("found"):b()},function(a){d(a)})},function(a){"found"===a?d():d(a?a:"Offer available on "+b.toUpperCase()+" outside the timings for all outlets.")})},function(a){c(a)})},function(a){a?b.reject(a):b.resolve(!0)}),b.promise},a.validateOfferValidity=function(){var b=c.defer();return!a.offer.offer_start_date||a.offer.offer_start_date>a.max_date?b.reject("Offer required valid start date."):!a.offer.offer_end_date||a.offer.offer_end_date>a.max_date?b.reject("Offer required valid end date."):!a.offer.offer_start_date>=a.offer.offer_end_date?b.reject("Offer start date cannot be before or same as offer end date"):a.offer.offer_outlets&&a.offer.offer_outlets.length?b.resolve(!0):b.reject("Please select atleast one outlet"),b.promise},a.getRange=function(a){return new Array(a)}}]),angular.module("merchantApp").controller("OfferManageController",["$scope","merchantRESTSvc","SweetAlert",function(a,b,c){_id=void 0,a.filters={header:"",line1:"",line2:"",offer_type:"",reward_type:""},a.offerFilter=function(b){var c=new RegExp(a.filters.header,"i"),d=new RegExp(a.filters.line1,"i"),e=new RegExp(a.filters.line2,"i"),f=new RegExp(a.filters.offer_type,"i"),g=new RegExp(a.filters.reward_type,"i");return c.test(b.actions.reward.header)&&d.test(b.actions.reward.line1)&&e.test(b.actions.reward.line2)&&g.test(b.actions.reward.reward_meta.reward_type)&&f.test(b.offer_type)},a.getOffers=function(){b.getOutlets().then(function(b){a.outlets=b.data,a.offers=[],a.offer_ids=[],_.each(a.outlets,function(b){_.each(b.offers,function(b){-1===a.offer_ids.indexOf(b._id)&&(a.offer_ids.push(b._id),a.offers.push(b))})})},function(b){a.offers=[];var d=b.message?b.message:"Something went wrong";c.swal({title:"ERROR",text:d,type:"error",showCancelButton:!1,confirmButtonColor:"#DD6B55",confirmButtonText:"Continue",closeOnConfirm:!0})})},a.removeOffer=function(d){c.swal({title:"Are you sure?",text:"You will not be able to recover this offer",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, Delete It!",closeOnConfirm:!1},function(e){e&&b.deleteOffer(d).then(function(b){c.swal("SUCCESS","Offer deleted successfully","success"),a.getOffers()},function(a){c.swal({title:"ERROR",text:"Unable to delete this offer right now",type:"error",showCancelButton:!1,confirmButtonColor:"#DD6B55",confirmButtonText:"Continue",closeOnConfirm:!0})})})}}]),angular.module("merchantApp").controller("OfferViewController",["$scope","merchantRESTSvc","$q","SweetAlert","$state","$stateParams","$filter",function(a,b,c,d,e,f,g){a.today=new Date,a.today.setMilliseconds(0),a.today.setSeconds(0),a.today.setMinutes(0),a.today.setHours(0),a.max_date=new Date(a.today.getTime()+10368e6),a.max_date.setMilliseconds(999),a.max_date.setSeconds(59),a.max_date.setMinutes(59),a.max_date.setHours(23),a.days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],a.offer_types={checkin:"Checkin Offer",offer:"Promoted offer"},a.reward_types={buyxgety:"Buy X Get Y",free:"Free",flatoff:"Flat Off",discount:"Discount"},a.event_matches={"on every":"On Every",after:"After","on only":"On Only"},a.offer={offer_status:"draft",offer_type:"",user_sourced:!1,offer_start_date:_.clone(a.today),offer_end_date:new Date(a.today.getTime()+5184e6),rule:{},actions:{reward:{reward_meta:{},reward_hours:{monday:{closed:!1,timings:[{}]},tuesday:{closed:!1,timings:[{}]},wednesday:{closed:!1,timings:[{}]},thursday:{closed:!1,timings:[{}]},friday:{closed:!1,timings:[{}]},saturday:{closed:!1,timings:[{}]},sunday:{closed:!1,timings:[{}]}},applicability:{dine_in:!0,delivery:!0}}},offer_items:{all:!0}},b.getOutlets().then(function(b){a.outlets=_.indexBy(b.data,"_id"),console.log(a.outlets)},function(b){console.log(b),d.swal("Error getting outlets",b.message?b.message:"Something went wrong","error"),a.outlets=[]}),b.getOffer(f.offer_id).then(function(b){b.data.offer_cost&&(b.data.offer_cost=b.data.offer_cost.toString()),a.offer=_.merge(a.offer,b.data),_.each(a.offer.actions.reward.reward_hours,function(a){if(!a.is_closed){var b=new Date;b.setSeconds(0),b.setMilliseconds(0),_.each(a.timings,function(a){a.open.time=_.clone(b),a.open.time.setHours(a.open.hr),a.open.time.setMinutes(a.open.min),a.close.time=_.clone(b),a.close.time.setHours(a.close.hr),a.close.time.setMinutes(a.close.min)})}})},function(a){console.log("erro",a)})}]),angular.module("merchantApp").controller("OrderManageController",["$scope","merchantRESTSvc","SweetAlert","$rootScope","$cookies","$notification","$stateParams",function(a,b,c,d,e,f,g){a.showing,g.show?"accept"===g.show?a.showing="ACCEPTED":"assumed_delivered"===g.show?a.showing="ASSUMED_DELIVERED":"reject"===g.show?a.showing="REJECTED":"dispatch"===g.show?a.showing="DISPATCHED":a.showing="PENDING":a.showing="PENDING",a.current_order=-1,a.reject_reasons=["Reason 1","Reason 2","Reason 3","Reason 4"],a.faye_handler=function(c){console.log("faye message",c),b.getOrder(c.order_id).then(function(b){d.notification_count+=1,d.sound.is_playing||(d.sound.is_playing=!0,d.sound.play());var e=f("New Order",{body:c.message||"You have an order",delay:0,dir:"auto"});e.$on("click",function(){console.debug("The user has clicked in my notification."),a.orders.push(b.data),a.updateShowing("pending"),e.close()}),e.$on("close",function(){console.debug("The user has closed my notification."),e.close(),d.notification_count-=1,d.notification_count||(d.sound.stop(),d.sound.is_playing=!1),a.updateShowing("PENDING")})},function(a){console.log("unable to load order",a)})},d.setHandler(a.faye_handler),a.updateShowing=function(b){a.showing=b,a.order={},a.filterOrders(),a.getOrders()},a.updateSub=function(b){d.subscribeOutlet(b),a.getOrders()},b.getOutlets().then(function(b){console.log("res",b),a.outlets=_.indexBy(b.data,"_id"),a.subscribed_outlet=d.subscribed_outlet,b.data.length&&a.getOrders()},function(b){console.log(b),a.outlets={}}),a.orders=[],a.filtered_orders=[],a.getOrders=function(){b.getOrders(d.subscribed_outlet).then(function(b){console.log(b),a.orders=b.data,a.filterOrders()},function(a){console.log(a)})},a.filterOrders=function(){a.filtered_orders=_.filter(a.orders,function(b){return b.order_status===a.showing})},a.getItemPrice=function(a){var b=0;return a.option&&a.option._id?(b+=a.option.option_cost,(a.option_is_addon===!0||a.option_price_is_additive===!0)&&(b+=a.item_cost),a.option.sub_options&&a.option.sub_options.length&&_.each(a.option.sub_options,function(a){b+=a.sub_option_set[0].sub_option_cost}),a.option.addons&&a.option.addons.length&&_.each(a.option.addons,function(a){_.each(a.addon_set,function(a){b+=a.addon_cost})}),b):a.item_cost},a.updateEstimateTime=function(a,b){a.estimate_time+=b},a.getDiscount=function(a){return a.order_value_without_offer-a.order_value_with_offer+a.order_value_with_offer*(a.cash_back/100)},a.viewOrder=function(b,c){a.order=b,a.current_order=c},a.acceptOrder=function(){var d=_.cloneDeep(a.order);d.update_type="accept",d.order_id=a.order._id,d.am_email=a.outlets[a.order.outlet].basics.account_mgr_email,c.swal({title:"Estimate Time?",text:"Provide an estimate time for delivery - in minutes.",type:"input",showCancelButton:!0,closeOnConfirm:!1,animation:"slide-from-top"},function(e){var f;if(!e)return swal.showInputError("Estimate delivery time (in mins.) required"),!1;try{if(f=Number(e),f!==f)return swal.showInputError("Valid estimate delivery time(in minutes) required"),!1;d.estimate_time=f,b.updateOrder(d).then(function(b){console.log(b),a.order.order_status="ACCEPTED",a.order.actions.push({action_type:"ACCEPTED",action_at:new Date}),a.orders[a.current_order]=a.order,c.swal("SUCCESS","Order accepted successfully","success"),a.filterOrders()},function(a){console.log(a),c.swal("ERROR",a.message?a.message:"Something went wrong. Please try after sometime.","error")})}catch(g){return swal.showInputError("Valid estimate delivery time(in minutes) required"),!1}})},a.showReject=function(){a.show_reject_msg=!0},a.rejectOrder=function(d){var e=_.cloneDeep(a.order);e.update_type="reject",e.order_id=a.order._id,e.am_email=a.outlets[a.order.outlet].basics.account_mgr_email,c.swal({title:"Are you sure?",text:"This is an irreversible change. Do you still want to proceed?",type:"warning",showCancelButton:!0,closeOnConfirm:!1,animation:"slide-from-top"},function(f){return f?(e.reject_reason=d,b.updateOrder(e).then(function(b){a.order.order_status="REJECTED",a.order.actions.push({action_type:"REJECTED",action_at:new Date,comments:d}),a.orders[a.current_order]=a.order,c.swal("SUCCESS","Order rejected successfully","info"),a.filterOrders()},function(a){console.log(a),c.swal("ERROR",a.message?a.message:"Something went wrong. Please try after sometime.","error")}),!0):void 0})},a.dispatchOrder=function(){var d=_.cloneDeep(a.order);d.update_type="dispatch",d.order_id=a.order._id,d.am_email=a.outlets[a.order.outlet].basics.account_mgr_email,b.updateOrder(d).then(function(b){a.order.order_status="DISPATCHED",a.order.actions.push({action_type:"DISPATCHED",action_at:new Date}),a.orders[a.current_order]=a.order,c.swal("SUCCESS","Order dispatch updated successfully","success"),a.filterOrders()},function(a){console.log(a),c.swal("ERROR",a.message?a.message:"Something went wrong. Please try after sometime.","error")})}}]),angular.module("merchantApp").controller("OutletCreateController",["$scope","merchantRESTSvc","$stateParams","$rootScope","SweetAlert","$state","$q","$modal","toastr","imageSvc",function(a,b,c,d,e,f,g,h,i,j){a.cuisines=["African","American","Andhra","Arabic","Armenian","Asian","Assamese","Awadhi","Bangladeshi","Belgian","Bengali","Biryani","British","Burmese","Chettinad","Chinese","Continental","Costal","Desserts","European","Fast Food","Finger Food","French","German","Goan","Greek","Gujarati","Healthy Food","Hyderabadi","Ice creams","Indian","Indonesian","Italian","Japanese","Kashmiri","Konkan","Malayali","Korean","Lebanese","Lucknowi","Maharashtrian","Malaysian","Mangalorean","Mediterranean","Mexican","Moroccan","Mughlai","Naga","Nepalese","North Eastern","North Indian","Oriya","Paan","Pakistani","Parsi","Pizza","Portuguese","Punjabi","Rajasthani","Russian","Sri Lankan","Sindhi","Singaporean","South American","South Indian","Spanish","Street Food","Sushi","Tex-Mex","Thai","Tibetan","Turkish","Vietnamese","Wraps","Bakery","Beverages","Burgers","Cafe","Salads","Sandwiches","Seafood","Middle Eastern","Steaks","Sizzlers"],a.outlet={sms_off:{value:!1},twyst_meta:{twyst_commission:{is_fixed:!0,value:0,commission_slab:[]},cashback_info:{order_amount_slab:[]}},attributes:{dine_in:!0,alcohol:!1,home_delivery:!0,cost_for_two:{},cuisines:[],payment_options:[],delivery:{delivery_zone:[]}},contact:{location:{coords:{},locality_1:[""],locality_2:[""],landmarks:[]},phones:{mobile:[{num:"",num_type:"mobile"}],reg_mobile:[{num:""}]},emails:{type:"work"}},photos:{others:[]},menus:[],links:{short_url:[""],other_links:[]},business_hours:{monday:{closed:!1,timings:[{}]},tuesday:{closed:!1,timings:[{}]},wednesday:{closed:!1,timings:[{}]},thursday:{closed:!1,timings:[{}]},friday:{closed:!1,timings:[{}]},saturday:{closed:!1,timings:[{}]},sunday:{closed:!1,timings:[{}]}}},a.map={center:{latitude:28.805422897457664,longitude:77.16647699812656},zoom:14},a.map2={center:{latitude:28.805422897457664,longitude:77.16647699812656},zoom:14,bounds:{}},a.options={scrollwheel:!0},a.drawingManagerOptions={drawingMode:"polygon",drawingControl:!1,drawingControlOptions:{position:2,drawingModes:["polygon"]}},a.drawingManagerControl={},a.drawingManagerEvents={polygoncomplete:function(b,c,d,e){var f=e[0],g=f.getPath().getArray(),i=_.map(g,function(a){return{latitude:a.lat(),longitude:a.lng()}}),j=a.outlet.attributes.delivery.delivery_zone.length-1,k=h.open({animation:!0,templateUrl:"templates/partials/delivery_zone.tmpl.html",size:"lg",controller:"DeliveryZoneController",resolve:{delivery_zone:function(){var b=_.cloneDeep(i),c={coord:i};return-1!=j&&(c=_.merge(c,a.outlet.attributes.delivery.delivery_zone[j])),c.coord=b,c},is_new:function(){return!0},is_first:function(){return-1===j?!1:!0}}});k.result.then(function(b){-1===j&&(a.outlet.business_hours=_.cloneDeep(b.delivery_timings)),a.outlet.attributes.delivery.delivery_zone.push(b)},function(){f.setMap(null)})}},a.editZone=function(b){var c=h.open({animation:!0,templateUrl:"templates/partials/delivery_zone.tmpl.html",size:"lg",controller:"DeliveryZoneController",resolve:{delivery_zone:function(){return _.cloneDeep(a.outlet.attributes.delivery.delivery_zone[b])},is_new:function(){return!1},is_first:function(){return!1}}});c.result.then(function(c){a.outlet.attributes.delivery.delivery_zone[b]=c})},a.removeZone=function(b){e.swal({title:"Are you sure?",text:"This change is irreversable",type:"error",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, delete it!"},function(c){c&&a.outlet.attributes.delivery.delivery_zone.splice(b,1)})},a.isPaying=d.isPaying,a.outlet_types=[{value:"bakery",name:"Bakery"},{value:"cafe",name:"Cafe"},{value:"delivery",name:"Delivery Only"},{value:"desserts",name:"Desserts"},{value:"pub_lounge",name:"Pub/Lounge"},{value:"fast_food",name:"QSR/Fast Food"},{value:"restaurant",name:"Restaurant"}],_id=c.outlet_id,a.marker={id:0,coords:{latitude:28.6078341976,longitude:77.2465642784},options:{draggable:!0},events:{dragend:function(b,c,d){var e=b.getPosition().lat(),f=b.getPosition().lng();a.outlet.contact.location.coords.longitude=f,a.outlet.contact.location.coords.latitude=e,a.outlet.contact.location.map_url="https://maps.google.com/maps/?q="+e+","+f+"&z="+a.map.zoom,a.marker.options={draggable:!0,labelAnchor:"100 0",labelClass:"marker-labels"}}}},a.days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],a.mapEvents={click:function(b,c,d){var e=d[0].latLng.G,f=d[0].latLng.K;a.$apply(function(){a.marker.coords={latitude:e,longitude:f},a.outlet.contact.location.coords={longitude:f,latitude:e},a.outlet.contact.location.map_url="https://maps.google.com/maps/?q="+e+","+f+"&z="+a.map.zoom})}},a.updateMapMarker=function(b,c){(a.outlet.contact.location.coords.latitude!==b||!a.outlet.contact.location.coords.longitude!==c)&&(a.outlet.contact.location.coords={latitude:b,longitude:c}),a.map.center={latitude:b,longitude:c},a.map2.center={latitude:b,longitude:c},a.marker.coords={latitude:b,longitude:c},a.outlet.contact.location.map_url="https://maps.google.com/maps/?q="+b+","+c+"&z="+a.map.zoom},b.getLocations().then(function(b){a.locations=b.data},function(b){a.locations=[]}),b.getOutlets().then(function(b){angular.forEach(b.data,function(b){b._id===c.outlet_id&&(a.outlet=angular.copy(b),a.outlet.attributes.cost_for_two.min=a.outlet.attributes.cost_for_two.min.toString(),a.outlet.attributes.cost_for_two.max=a.outlet.attributes.cost_for_two.max.toString(),a.map.center={latitude:a.outlet.contact.location.coords.latitude,longitude:a.outlet.contact.location.coords.longitude},a.marker.coords={latitude:a.outlet.contact.location.coords.latitude,longitude:a.outlet.contact.location.coords.longitude},angular.forEach(a.outlet.business_hours,function(a){angular.forEach(a.timings,function(a){var b=new Date;b.setHours(a.open.hr),b.setMinutes(a.open.min),b.setSeconds(0),b.setMilliseconds(0),a.open.time=_.clone(b),b.setHours(a.close.hr),b.setMinutes(a.close.min),a.close.time=_.clone(b)})}))})},function(a){console.log("err",a)}),a.mapOptions={scrollwheel:!0},a.addNumber=function(b){a.outlet.contact.phones[b]||(a.outlet.contact.phones[b]=[]);var c={num:"",num_type:"mobile"};a.outlet.contact.phones[b].push(c)},a.removeNumber=function(a,b){a.splice(b,1)},a.addCuisine=function(b){b&&(a.outlet.attributes.cuisines||(a.outlet.attributes.cuisines=[]),-1===a.outlet.attributes.cuisines.indexOf(b)&&a.outlet.attributes.cuisines.push(b))},a.removeCuisine=function(b){a.outlet.attributes.cuisines.splice(b,1)},a.updateCommission=function(){a.outlet.twyst_meta.twyst_commission.is_fixed?a.outlet.twyst_meta.twyst_commission.commission_slab=[]:(delete a.outlet.twyst_meta.twyst_commission.value,a.outlet.twyst_meta.twyst_commission.commission_slab=[{has_upper_bound:!0}])},a.addCommissionSlab=function(){a.outlet.twyst_meta.twyst_commission.commission_slab.push({has_upper_bound:!0})},a.addCashbackSlab=function(){a.outlet.twyst_meta.cashback_info.order_amount_slab.push({})},a.removeSlab=function(a,b){a.splice(b,1)},a.updateSMSOff=function(){a.outlet.sms_off.value?a.outlet.sms_off.time={start:{hr:23,min:0},end:{hr:9,min:0}}:a.outlet.sms_off.time={}},a.updateTiming=function(a,b){b[a].closed?b[a].timings=[]:b[a].timings=[{}]},a.initalizeTiming=function(a,b,c){if(!c[a].timings[b].open||!c[a].timings[b].close){var e=new Date;d.isPaying?(e.setHours(9),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0)):(e.setHours(0),e.setMinutes(1),e.setSeconds(0),e.setMilliseconds(0));var f=new Date;d.isPaying?(f.setHours(21),f.setMinutes(0),f.setSeconds(0),f.setMilliseconds(0)):(f.setHours(0),f.setMinutes(0),f.setSeconds(0),f.setMilliseconds(0)),d.isPaying?c[a].timings[b]={open:{hr:9,min:0,time:e},close:{hr:21,min:0,time:f}}:c[a].timings[b]={open:{hr:0,min:1,time:e},close:{hr:0,min:0,time:f}}}},a.updateTime=function(a,b,c){var d=c[a].timings[b];d.open.time&&(d.open.hr=d.open.time.getHours(),d.open.min=d.open.time.getMinutes()),d.close.time&&(d.close.hr=d.close.time.getHours(),d.close.min=d.close.time.getMinutes())},a.chooseImage=function(){var b=h.open({animation:!0,templateUrl:"templates/partials/background_picker.html",size:"lg",controller:"ImagePickerController"});b.result.then(function(b){var c={};c.source=b,c.image_type="background",_id&&(c.id=_id),j.cloneImage(c).then(function(b){_id=b.data.id,a.outlet.photos.background="asd",a.outlet.photos.background=b.data.key,i.success("Image set successfully")},function(a){console.log(a)})},function(a){console.info("Modal dismissed at: "+new Date,a)})},a.getMaxRange=function(){return new Array(_.reduce(a.outlet.business_hours,function(a,b){return _.has(a,"timings")?a.timings.length>b.timings.length?a.timings.length:b.timings.length:a>=b.timings.length?a:b.timings.length}))},a.addNewTiming=function(a,b){b[a].timings.push({})},a.removeTiming=function(a,b,c){c[a].timings.splice(b,1)},a.cloneToAllDays=function(a,b){_.each(b,function(c,d){d!==a&&(c.timings=_.cloneDeep(b[a].timings),c.closed=b[a].closed)})},a.createOutlet=function(){var c=_.cloneDeep(a.outlet);c._id=_id,b.createOutlet(a.outlet).then(function(a){e.swal({title:"Outlet created successfully",type:"success",showCancelButton:!1,confirmButtonText:"Continue"},function(){f.go("^.outlets_manage")})},function(a){console.log(a);var b=a.message||"Something went wrong";e.swal({title:"Error",text:b,showCancelButton:!1,confirmButtonColor:"#DD6B55"
})})},a.scrollToTop=function(){$("document").ready(function(){$(window).scrollTop(0)})},a.showErrorMessage=function(b){a.formFailure=!0,e.swal({title:"Validation Error",text:b,type:"error",showCancelButton:!1,confirmButtonText:"OK",closeOnConfirm:!0})},a.validateStep1=function(){a.formFailure=!1;var b=g.defer();return _.get(a.outlet,"basics.name")?_.get(a.outlet,"contact.location.address")?_.get(a.outlet,"contact.location.city")?_.get(a.outlet,"contact.location.locality_2[0]")?_.get(a.outlet,"links.short_url[0]")?!_.get(a.outlet,"contact.location.coords.longitude")&&0!==a.outlet.contact.location.coords.longitude||!_.get(a.outlet,"contact.location.coords.latitude")&&0!==a.outlet.contact.location.coords.latitude?(a.showErrorMessage("Geo-location data is missing"),b.reject()):async.each(a.outlet.contact.phones.mobile,function(a,b){a.num?"mobile"==a.num_type&&!/^[0-9]{10}$/.test(a.num)||"landline"==a.num_type&&!/^[0-9]{11}$/.test(a.num)?b("One or more outlet numbers are invalid"):b():b("One or more outlet numbers left blank")},function(c){c?(a.showErrorMessage(c),b.reject()):async.each(a.outlet.contact.phones.reg_mobile,function(a,b){a.num?/^[0-9]{10,11}$/.test(a.num)?b():b("One or more registered mobile numbers are invalid"):b("One or more registered mobile numbers left blank")},function(c){c?(a.showErrorMessage(c),b.reject()):!_.get(a.outlet,"contact.emails.person")&&d.isPaying?(a.showErrorMessage("Contact person's name required"),b.reject()):!_.get(a.outlet,"contact.emails.email")&&d.isPaying?(a.showErrorMessage("Contact person's Email ID required"),b.reject()):_.get(a.outlet,"basics.account_mgr_email")?_.get(a.outlet,"basics.account_mgr_phone")?(a.scrollToTop(),a.formFailure=!1,b.resolve(!0)):a.showErrorMessage("Account manager's phone required"):a.showErrorMessage("Account manager's email ID required")})}):a.showErrorMessage("Short code cannot be left blank"):(a.showErrorMessage("Locality 2 must be specified"),b.reject()):(a.showErrorMessage("City must be selected"),b.reject()):(a.showErrorMessage("Complete address is mandatory"),b.reject()):(a.showErrorMessage("Outlet name is mandatory"),b.reject()),b.promise},a.validateStep2=function(){var b=g.defer();if(_.get(a.outlet,"basics.main_type"))if(_.get(a.outlet,"attributes.cost_for_two.min")&&_.get(a.outlet,"attributes.cost_for_two.max")||!d.isPaying)if(a.outlet.attributes.dine_in||a.outlet.attributes.home_delivery||!d.isPaying)if(!a.outlet.attributes.cuisines.length&&d.isPaying)a.showErrorMessage("Atleast one cuisine must be specified"),b.reject();else if(a.outlet.sms_off.value)if(!a.outlet.sms_off.time.start.hr&&0!==a.outlet.sms_off.time.start.hr||!a.outlet.sms_off.time.start.min&&0!==a.outlet.sms_off.time.start.min)a.showErrorMessage("SMS OFF start time invalid"),b.reject();else if(!a.outlet.sms_off.time.end.hr&&0!==a.outlet.sms_off.time.end.hr||!a.outlet.sms_off.time.end.min&&0!==a.outlet.sms_off.time.end.min)a.showErrorMessage("SMS OFF end time invalid"),b.reject();else{var c=60*a.outlet.sms_off.time.start.hr+a.outlet.sms_off.time.start.min,e=60*a.outlet.sms_off.time.end.hr+a.outlet.sms_off.time.end.min;c==e?(a.showErrorMessage("SMS Off start and end time cannot be the same"),b.reject()):(a.scrollToTop(),a.formFailure=!1,b.resolve(!0))}else a.scrollToTop(),a.formFailure=!1,b.resolve(!0);else a.showErrorMessage("Outlet must have atleast dine-in or delivery available"),b.reject();else a.showErrorMessage('Please provide both minimum and maximum "Cost for Two"'),b.reject();else a.showErrorMessage("Please choose an outlet type"),b.reject();return b.promise},a.validateStep3=function(){var b=g.defer();return async.each(Object.keys(a.outlet.business_hours),function(b,c){var d=a.outlet.business_hours[b];d.closed?c():async.each(d.timings,function(a,c){!a.open.hr&&0!==a.open.hr||!a.open.min&&0!==a.open.min||!a.close.hr&&0!==a.close.hr||!a.close.min&&0!==a.close.min?c("One or more timings invalid for "+b.toUpperCase()):async.each(d.timings,function(c,d){if(!c.open.hr&&0!==c.open.hr||!c.open.min&&0!==c.open.min||!c.close.hr&&0!==c.close.hr||!c.close.min&&0!==c.close.min)d("One or more timings invalid for "+b.toUpperCase());else{var e=60*a.open.hr+a.open.min,f=60*a.close.hr+a.close.min,g=60*c.open.hr+c.open.min,h=60*c.close.hr+c.close.min;a==c?d():h>=e&&f>=h||g>=e&&f>=g||f>=g&&h>=f?d("One or more timings invalid for "+b.toUpperCase()):d()}},function(a){c(a)})},function(a){c(a)})},function(c){c?(a.showErrorMessage(c),b.reject()):(a.scrollToTop(),a.formFailure=!1,b.resolve(!0))}),b.promise},a.validateStep4=function(){var b=g.defer();return _.get(a.outlet,"photos.logo")?_.get(a.outlet,"photos.background")?(a.scrollToTop(),a.formFailure=!1,b.resolve(!0)):(a.showErrorMessage("Background image is mandatory"),b.reject()):(a.showErrorMessage("Logo is mandatory"),b.reject()),b.promise}}]),angular.module("merchantApp").controller("OutletEditController",["$scope","merchantRESTSvc","$stateParams","$rootScope","SweetAlert","$state","$q","$modal","toastr",function(a,b,c,d,e,f,g,h,i){a.cuisines=["African","American","Andhra","Arabic","Armenian","Asian","Assamese","Awadhi","Bangladeshi","Belgian","Bengali","Biryani","British","Burmese","Chettinad","Chinese","Continental","Costal","Desserts","European","Fast Food","Finger Food","French","German","Goan","Greek","Gujarati","Healthy Food","Hyderabadi","Ice creams","Indian","Indonesian","Italian","Japanese","Kashmiri","Konkan","Malayali","Korean","Lebanese","Lucknowi","Maharashtrian","Malaysian","Mangalorean","Mediterranean","Mexican","Moroccan","Mughlai","Naga","Nepalese","North Eastern","North Indian","Oriya","Paan","Pakistani","Parsi","Pizza","Portuguese","Punjabi","Rajasthani","Russian","Sri Lankan","Sindhi","Singaporean","South American","South Indian","Spanish","Street Food","Sushi","Tex-Mex","Thai","Tibetan","Turkish","Vietnamese","Wraps","Bakery","Beverages","Burgers","Cafe","Salads","Sandwiches","Seafood","Middle Eastern","Steaks","Sizzlers"],a.map={center:{latitude:28.805422897457664,longitude:77.16647699812656},zoom:14},a.map2={center:{latitude:28.805422897457664,longitude:77.16647699812656},zoom:14,bounds:{}},a.drawingManagerOptions={drawingMode:"polygon",drawingControl:!1,drawingControlOptions:{position:2,drawingModes:["polygon"]}},a.drawingManagerControl={},a.drawingManagerEvents={polygoncomplete:function(b,c,d,e){var f=e[0],g=f.getPath().getArray(),i=_.map(g,function(a){return{latitude:a.lat(),longitude:a.lng()}}),j=a.outlet.attributes.delivery.delivery_zone.length-1,k=h.open({animation:!0,templateUrl:"templates/partials/delivery_zone.tmpl.html",size:"lg",controller:"DeliveryZoneController",resolve:{delivery_zone:function(){var b=_.cloneDeep(i),c={coord:i};return-1!=j&&(c=_.merge(c,a.outlet.attributes.delivery.delivery_zone[j])),c.coord=b,c},is_new:function(){return!0},is_first:function(){return-1===j?!1:!0}}});k.result.then(function(b){a.outlet.attributes.delivery.delivery_zone.push(b)},function(){f.setMap(null)})}},a.editZone=function(b){var c=h.open({animation:!0,templateUrl:"templates/partials/delivery_zone.tmpl.html",size:"lg",controller:"DeliveryZoneController",resolve:{delivery_zone:function(){return _.cloneDeep(a.outlet.attributes.delivery.delivery_zone[b])},is_new:function(){return!1},is_first:function(){return!1}}});c.result.then(function(c){a.outlet.attributes.delivery.delivery_zone[b]=c})},a.removeZone=function(b){e.swal({title:"Are you sure?",text:"This change is irreversable",type:"error",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, delete it!"},function(c){c&&a.outlet.attributes.delivery.delivery_zone.splice(b,1)})},a.isPaying=d.isPaying,a.outlet_types=[{value:"bakery",name:"Bakery"},{value:"cafe",name:"Cafe"},{value:"delivery",name:"Delivery Only"},{value:"desserts",name:"Desserts"},{value:"pub_lounge",name:"Pub/Lounge"},{value:"fast_food",name:"QSR/Fast Food"},{value:"restaurant",name:"Restaurant"}],a.outlet={},_id=c.outlet_id,a.marker={id:0,coords:{latitude:28.6078341976,longitude:77.2465642784},options:{draggable:!0},events:{dragend:function(b,c,d){var e=b.getPosition().lat(),f=b.getPosition().lng();a.outlet.contact.location.coords.longitude=f,a.outlet.contact.location.coords.latitude=e,a.outlet.contact.location.map_url="https://maps.google.com/maps/?q="+e+","+f+"&z="+a.map.zoom,a.marker.options={draggable:!0,labelAnchor:"100 0",labelClass:"marker-labels"}}}},a.days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],a.mapEvents={click:function(b,c,d){var e=d[0].latLng.G,f=d[0].latLng.K;a.$apply(function(){a.marker.coords={latitude:e,longitude:f},a.outlet.contact.location.coords={longitude:f,latitude:e},a.outlet.contact.location.map_url="https://maps.google.com/maps/?q="+e+","+f+"&z="+a.map.zoom})}},a.updateMapMarker=function(b,c){(a.outlet.contact.location.coords.latitude!==b||!a.outlet.contact.location.coords.longitude!==c)&&(a.outlet.contact.location.coords={latitude:b,longitude:c}),a.map.center={latitude:b,longitude:c},a.map2.center={latitude:b,longitude:c},a.marker.coords={latitude:b,longitude:c},a.outlet.contact.location.map_url="https://maps.google.com/maps/?q="+b+","+c+"&z="+a.map.zoom},b.getLocations().then(function(b){a.locations=b.data},function(b){a.locations=[]}),b.getOutlets().then(function(b){angular.forEach(b.data,function(b){b._id===c.outlet_id&&(a.outlet=angular.copy(b),a.outlet.attributes.cost_for_two.min=a.outlet.attributes.cost_for_two.min.toString(),a.outlet.attributes.cost_for_two.max=a.outlet.attributes.cost_for_two.max.toString(),a.map.center={latitude:a.outlet.contact.location.coords.latitude,longitude:a.outlet.contact.location.coords.longitude},a.map2.center={latitude:a.outlet.contact.location.coords.latitude,longitude:a.outlet.contact.location.coords.longitude},a.marker.coords={latitude:a.outlet.contact.location.coords.latitude,longitude:a.outlet.contact.location.coords.longitude},angular.forEach(a.outlet.business_hours,function(a){angular.forEach(a.timings,function(a){var b=new Date;b.setHours(a.open.hr),b.setMinutes(a.open.min),b.setSeconds(0),b.setMilliseconds(0),a.open.time=_.clone(b),b.setHours(a.close.hr),b.setMinutes(a.close.min),a.close.time=_.clone(b)})}),angular.forEach(a.outlet.attributes.delivery.delivery_zone,function(b){angular.forEach(a.days,function(a){angular.forEach(b.delivery_timings[a].timings,function(a){var b=new Date,c=new Date;b.setMilliseconds(0),b.setSeconds(0),b.setHours(a.open.hr),b.setMinutes(a.open.min),c.setMilliseconds(0),c.setSeconds(0),c.setHours(a.close.hr),c.setMinutes(a.close.min),a.open.time=b,a.close.time=c})})}))})},function(a){console.log("err",a)}),a.mapOptions={scrollwheel:!0},a.addNumber=function(b){a.outlet.contact.phones[b]||(a.outlet.contact.phones[b]=[]);var c={num:"",num_type:"mobile"};a.outlet.contact.phones[b].push(c)},a.removeNumber=function(a,b){a.splice(b,1)},a.addCuisine=function(b){b&&(a.outlet.attributes.cuisines||(a.outlet.attributes.cuisines=[]),-1===a.outlet.attributes.cuisines.indexOf(b)&&a.outlet.attributes.cuisines.push(b))},a.removeCuisine=function(b){a.outlet.attributes.cuisines.splice(b,1)},a.updateCommission=function(){a.outlet.twyst_meta.twyst_commission.is_fixed?a.outlet.twyst_meta.twyst_commission.commission_slab=[]:(delete a.outlet.twyst_meta.twyst_commission.value,a.outlet.twyst_meta.twyst_commission.commission_slab=[{has_upper_bound:!0}])},a.addCommissionSlab=function(){a.outlet.twyst_meta.twyst_commission.commission_slab.push({has_upper_bound:!0})},a.addCashbackSlab=function(){a.outlet.twyst_meta.cashback_info.order_amount_slab.push({})},a.removeSlab=function(a,b){a.splice(b,1)},a.updateSMSOff=function(){a.outlet.sms_off.value?a.outlet.sms_off.time={start:{hr:23,min:0},end:{hr:9,min:0}}:a.outlet.sms_off.time={}},a.updateTiming=function(a,b){b[a].closed?b[a].timings=[]:b[a].timings=[{}]},a.initalizeTiming=function(a,b,c){if(!c[a].timings[b].open||!c[a].timings[b].close){var e=new Date;d.isPaying?(e.setHours(9),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0)):(e.setHours(0),e.setMinutes(1),e.setSeconds(0),e.setMilliseconds(0));var f=new Date;d.isPaying?(f.setHours(21),f.setMinutes(0),f.setSeconds(0),f.setMilliseconds(0)):(f.setHours(0),f.setMinutes(0),f.setSeconds(0),f.setMilliseconds(0)),d.isPaying?c[a].timings[b]={open:{hr:9,min:0,time:e},close:{hr:21,min:0,time:f}}:c[a].timings[b]={open:{hr:0,min:1,time:e},close:{hr:0,min:0,time:f}}}},a.updateTime=function(a,b,c){var d=c[a].timings[b];d.open.time&&(d.open.hr=d.open.time.getHours(),d.open.min=d.open.time.getMinutes()),d.close.time&&(d.close.hr=d.close.time.getHours(),d.close.min=d.close.time.getMinutes())},a.chooseImage=function(){var b=h.open({animation:!0,templateUrl:"templates/partials/background_picker.html",size:"lg",controller:"ImagePickerController"});b.result.then(function(b){var c={};c.source=b,c.image_type="background",_id&&(c.id=_id),imageSvc.cloneImage(c).then(function(b){a.outlet.photos.background="asd",a.outlet.photos.background=b.data.key,i.success("Image set successfully")},function(a){console.log(a)})},function(a){console.info("Modal dismissed at: "+new Date,a)})},a.getMaxRange=function(){return new Array(_.reduce(a.outlet.business_hours,function(a,b){return _.has(a,"timings")?a.timings.length>b.timings.length?a.timings.length:b.timings.length:a>=b.timings.length?a:b.timings.length}))},a.addNewTiming=function(a,b){b[a].timings.push({})},a.removeTiming=function(a,b,c){c[a].timings.splice(b,1)},a.cloneToAllDays=function(a,b){_.each(b,function(c,d){d!==a&&(c.timings=_.cloneDeep(b[a].timings),c.closed=b[a].closed)})},a.updateOutlet=function(){b.updateOutlet(a.outlet).then(function(a){e.swal({title:"Outlet updated successfully",type:"success",showCancelButton:!1,confirmButtonText:"Continue"},function(){f.go("^.outlets_manage",{},{reload:!0})})},function(a){console.log(a);var b=a.message?a.message:"Something went wrong";e.swal("Service error",b,"error")})},a.scrollToTop=function(){$("document").ready(function(){$(window).scrollTop(0)})},a.showErrorMessage=function(b){a.formFailure=!0,e.swal({title:"Validation Error",text:b,type:"error",showCancelButton:!1,confirmButtonText:"OK",closeOnConfirm:!0})},a.validateStep1=function(){a.formFailure=!1;var b=g.defer();return _.get(a.outlet,"basics.name")?_.get(a.outlet,"contact.location.address")?_.get(a.outlet,"contact.location.city")?_.get(a.outlet,"contact.location.locality_2[0]")?_.get(a.outlet,"links.short_url[0]")?!_.get(a.outlet,"contact.location.coords.longitude")&&0!==a.outlet.contact.location.coords.longitude||!_.get(a.outlet,"contact.location.coords.latitude")&&0!==a.outlet.contact.location.coords.latitude?(a.showErrorMessage("Geo-location data is missing"),b.reject()):async.each(a.outlet.contact.phones.mobile,function(a,b){a.num?"mobile"==a.num_type&&!/^[0-9]{10}$/.test(a.num)||"landline"==a.num_type&&!/^[0-9]{11}$/.test(a.num)?b("One or more outlet numbers are invalid"):b():b("One or more outlet numbers left blank")},function(c){c?(a.showErrorMessage(c),b.reject()):async.each(a.outlet.contact.phones.reg_mobile,function(a,b){a.num?/^[0-9]{10,11}$/.test(a.num)?b():b("One or more registered mobile numbers are invalid"):b("One or more registered mobile numbers left blank")},function(c){c?(a.showErrorMessage(c),b.reject()):!_.get(a.outlet,"contact.emails.person")&&d.isPaying?(a.showErrorMessage("Contact person's name required"),b.reject()):!_.get(a.outlet,"contact.emails.email")&&d.isPaying?(a.showErrorMessage("Contact person's Email ID required"),b.reject()):_.get(a.outlet,"basics.account_mgr_email")?_.get(a.outlet,"basics.account_mgr_phone")?(a.scrollToTop(),a.formFailure=!1,b.resolve(!0)):a.showErrorMessage("Account manager's phone required"):a.showErrorMessage("Account manager's email ID required")})}):a.showErrorMessage("Short code cannot be left blank"):(a.showErrorMessage("Locality 2 must be specified"),b.reject()):(a.showErrorMessage("City must be selected"),b.reject()):(a.showErrorMessage("Complete address is mandatory"),b.reject()):(a.showErrorMessage("Outlet name is mandatory"),b.reject()),b.promise},a.validateStep2=function(){var b=g.defer();if(_.get(a.outlet,"basics.main_type"))if(_.get(a.outlet,"attributes.cost_for_two.min")&&_.get(a.outlet,"attributes.cost_for_two.max")||!d.isPaying)if(a.outlet.attributes.dine_in||a.outlet.attributes.home_delivery||!d.isPaying)if(!a.outlet.attributes.cuisines.length&&d.isPaying)a.showErrorMessage("Atleast one cuisine must be specified"),b.reject();else if(a.outlet.sms_off.value)if(!a.outlet.sms_off.time.start.hr&&0!==a.outlet.sms_off.time.start.hr||!a.outlet.sms_off.time.start.min&&0!==a.outlet.sms_off.time.start.min)a.showErrorMessage("SMS OFF start time invalid"),b.reject();else if(!a.outlet.sms_off.time.end.hr&&0!==a.outlet.sms_off.time.end.hr||!a.outlet.sms_off.time.end.min&&0!==a.outlet.sms_off.time.end.min)a.showErrorMessage("SMS OFF end time invalid"),b.reject();else{var c=60*a.outlet.sms_off.time.start.hr+a.outlet.sms_off.time.start.min,e=60*a.outlet.sms_off.time.end.hr+a.outlet.sms_off.time.end.min;c==e?(a.showErrorMessage("SMS Off start and end time cannot be the same"),b.reject()):(a.scrollToTop(),a.formFailure=!1,b.resolve(!0))}else a.scrollToTop(),a.formFailure=!1,b.resolve(!0);else a.showErrorMessage("Outlet must have atleast dine-in or delivery available"),b.reject();else a.showErrorMessage('Please provide both minimum and maximum "Cost for Two"'),b.reject();else a.showErrorMessage("Please choose an outlet type"),b.reject();return b.promise},a.validateStep3=function(){var b=g.defer();return async.each(Object.keys(a.outlet.business_hours),function(b,c){var d=a.outlet.business_hours[b];d.closed?c():async.each(d.timings,function(a,c){!a.open.hr&&0!==a.open.hr||!a.open.min&&0!==a.open.min||!a.close.hr&&0!==a.close.hr||!a.close.min&&0!==a.close.min?c("One or more timings invalid for "+b.toUpperCase()):async.each(d.timings,function(c,d){if(!c.open.hr&&0!==c.open.hr||!c.open.min&&0!==c.open.min||!c.close.hr&&0!==c.close.hr||!c.close.min&&0!==c.close.min)d("One or more timings invalid for "+b.toUpperCase());else{var e=60*a.open.hr+a.open.min,f=60*a.close.hr+a.close.min,g=60*c.open.hr+c.open.min,h=60*c.close.hr+c.close.min;a==c?d():h>=e&&f>=h||g>=e&&f>=g||f>=g&&h>=f?d("One or more timings invalid for "+b.toUpperCase()):d()}},function(a){c(a)})},function(a){c(a)})},function(c){c?(a.showErrorMessage(c),b.reject()):(a.scrollToTop(),a.formFailure=!1,b.resolve(!0))}),b.promise},a.validateStep4=function(){var b=g.defer();return _.get(a.outlet,"photos.logo")?_.get(a.outlet,"photos.background")?(a.scrollToTop(),a.formFailure=!1,b.resolve(!0)):(a.showErrorMessage("Background image is mandatory"),b.reject()):(a.showErrorMessage("Logo is mandatory"),b.reject()),b.promise}}]),angular.module("merchantApp").controller("OutletManageController",["$scope","$rootScope","merchantRESTSvc","SweetAlert",function(a,b,c,d){a.filters={name:"",locality1:"",locality2:"",city:""},_id=void 0,a.getOutlets=function(){c.getOutlets().then(function(b){a.outlets=b.data},function(b){a.outlets=[],console.log(b)})},a.removeOutlet=function(b){d.swal({title:"Are you sure?",text:"You will not be able to recover this outlet",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, Delete It!",closeOnConfirm:!1},function(e){e&&c.deleteOutlet(b).then(function(b){d.swal("SUCCESS","Outlet deleted successfully","success"),a.getOutlets()},function(a){d.swal({title:"ERROR",text:"Unable to delete this outlet right now",type:"error",showCancelButton:!1,confirmButtonColor:"#DD6B55",confirmButtonText:"Continue",closeOnConfirm:!0})})})},a.outletFilter=function(b){var c=new RegExp(a.filters.name,"i"),d=new RegExp(a.filters.locality1,"i"),e=new RegExp(a.filters.locality2,"i"),f=new RegExp(a.filters.city,"i");return c.test(b.basics.name)&&d.test(b.contact.location.locality_1[0])&&e.test(b.contact.location.locality_2[0])&&f.test(b.contact.location.city)}}]),angular.module("merchantApp").controller("OutletViewController",["$scope","merchantRESTSvc","$stateParams",function(a,b,c){a.days=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],a.marker={id:0,coords:{latitude:28.6078341976,longitude:77.2465642784}},a.map={center:{latitude:28.805422897457664,longitude:77.16647699812656},zoom:14},b.getOutlets().then(function(b){angular.forEach(b.data,function(b){b._id===c.outlet_id&&(a.outlet=angular.copy(b),a.outlet.attributes.cost_for_two.min=a.outlet.attributes.cost_for_two.min.toString(),a.outlet.attributes.cost_for_two.max=a.outlet.attributes.cost_for_two.max.toString(),a.map.center={latitude:a.outlet.contact.location.coords.latitude,longitude:a.outlet.contact.location.coords.longitude},a.marker.coords={latitude:a.outlet.contact.location.coords.latitude,longitude:a.outlet.contact.location.coords.longitude},angular.forEach(a.outlet.business_hours,function(a){angular.forEach(a.timings,function(a){var b=new Date;b.setHours(a.open.hr),b.setMinutes(a.open.min),b.setSeconds(0),b.setMilliseconds(0),a.open.time=_.clone(b),b.setHours(a.close.hr),b.setMinutes(a.close.min),a.close.time=_.clone(b)})}))})},function(a){$log.log("err",a)})}]),angular.module("merchantApp").controller("RootController",["$scope","$rootScope","$state","merchantRESTSvc","SweetAlert","$cookies",function(a,b,c,d,e,f){b.token||"merchant.login"===c.current.name||c.go("merchant.login",{},{reload:!0}),a.logout=function(){d.logout().then(function(a){f.remove("token"),f.remove("isPaying"),f.put("subscribed_outlet",""),b.isPaying=void 0,b.token=void 0,b.subscribed_outlet="",e.swal({title:"Logged out successfully",type:"success",showCancelButton:!1,confirmButtonText:"Continue"},function(){c.go("merchant.login",{},{reload:!0})})},function(a){var b;b=a.message?a.message:"Something went wrong",e.swal({title:"ERROR",text:b,type:"error",confirmButtonText:"Continue",closeOnConfirm:!1})})}}]),angular.module("merchantApp").factory("imageSvc",["$http","$q",function(a,b){var c={};return c.uploadImage=function(c){var d=b.defer();return a.post("/api/v4/images",c).then(function(a){a.data.response?d.resolve(a.data):d.reject(a.data)},function(a){d.reject(a)}),d.promise},c.cloneImage=function(c){var d=b.defer();return a.post("/api/v4/images/clone",c).then(function(a){a.data.response?d.resolve(a.data):d.reject(a.data)},function(a){d.reject(a)}),d.promise},c}]),angular.module("merchantApp").directive("imagereader",["imageSvc","toastr",function(a,b){return{require:"ngModel",restrict:"E",template:"<img class='img-polaroid'/><input id='fileInput' type='file' style='display: none;'/>",link:function(b,c,d,e){var f=$(angular.element('<input id="fileInput" type="file" />')),g=c.find("img")[0];f.on("change",function(b){var c=b.target.files[0],f=/^image\//i;if(f.test(c.type)){var h=new FileReader;h.onload=function(b){console.log(b.target.result);var c={image:b.target.result,image_class:d.ngImageFor,image_type:d.ngImageType};_id&&(c.id=_id),"menu"===d.ngImageFor&&e.$modelValue&&(c.item=e.$modelValue),a.uploadImage(c).then(function(a){console.log(a),_id=a.data.id,$(g).attr("src",b.target.result),e.$setViewValue(a.data.key.toString())},function(a){console.log("err",a)})},h.readAsDataURL(b.target.files[0])}}),c.bind("click",function(){f.trigger("click")}),c.css("cursor","pointer"),b.$watch(function(){return e.$modelValue},function(a){console.log("ngImageFor",d.ngImageFor,a),a&&(/^http/i.test(a)?$(g).attr("src",a):"menu"===d.ngImageFor?$(g).attr("src","https://s3-us-west-2.amazonaws.com/retwyst-merchants/retwyst-menus/"+_id+"/items/"+a):"outlet"===d.ngImageFor&&$(g).attr("src","https://s3-us-west-2.amazonaws.com/retwyst-merchants/retwyst-outlets/"+_id+"/"+a))})}}}]),angular.module("merchantApp").directive("toggleNavCollapsedMin",["$rootScope",function(a){function b(b,c,d){var e;e=$("#app"),c.on("click",function(b){return e.hasClass("nav-collapsed-min")?e.removeClass("nav-collapsed-min"):(e.addClass("nav-collapsed-min"),a.$broadcast("nav:reset")),b.preventDefault()})}var c={restrict:"A",link:b};return c}]),angular.module("merchantApp").factory("imageSvc",["$http","$q",function(a,b){var c={};return c.uploadImage=function(c){var d=b.defer();return a.post("/api/v4/images",c).then(function(a){a.data.response?d.resolve(a.data):d.reject(a.data)},function(a){d.reject(a)}),d.promise},c.cloneImage=function(c){var d=b.defer();return a.post("/api/v4/images/clone",c).then(function(a){a.data.response?d.resolve(a.data):d.reject(a.data)},function(a){d.reject(a)}),d.promise},c}]),angular.module("merchantApp").factory("merchantRESTSvc",["$http","$q","$cookies","$rootScope",function(a,b,c,d){var e={};return e.login=function(c){var d=b.defer();return a.post("/api/v4/accounts/login",c).then(function(a){a.data.response?d.resolve(a.data):d.reject(a.data)},function(a){d.reject(a)}),d.promise},e.logout=function(){var d=b.defer(),e=c.get("token");return a.get("/api/v4/accounts/logout?token="+e).then(function(a){a.data.response?d.resolve(a.data):d.reject(a.data)},function(a){d.reject(a)}),d.promise},e.getOutlets=function(){var d=b.defer(),e=c.get("token");return a.get("/api/v4/outlets?token="+e).then(function(a){a.data.response?d.resolve(a.data):d.reject(a.data)},function(a){d.reject(a)}),d.promise},e.getOutlet=function(d){var e=b.defer(),f=c.get("token");return a.get("/api/v4/outlets/"+d+"?token="+f).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.createOutlet=function(d){var e=b.defer(),f=c.get("token");return a.post("/api/v4/outlets?token="+f,d).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.updateOutlet=function(d){var e=b.defer(),f=c.get("token");return a.put("/api/v4/outlets/"+d._id+"?token="+f,d).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.deleteOutlet=function(d){var e=b.defer(),f=c.get("token");return a["delete"]("/api/v4/outlets/"+d+"?token="+f).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.createOffer=function(d){var e=b.defer(),f=c.get("token");return a.post("/api/v4/offers?token="+f,d).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.getOffer=function(d){var e=b.defer(),f=c.get("token");return a.get("/api/v4/offers/"+d+"?token="+f).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.updateOffer=function(d){var e=b.defer(),f=c.get("token");return a.put("/api/v4/offers/"+d._id+"?token="+f,d).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.deleteOffer=function(d){var e=b.defer(),f=c.get("token");return a["delete"]("/api/v4/offers/"+d+"?token="+f).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.getBills=function(){var d=b.defer(),e=c.get("token");return a.get("/api/v4/events/list/upload_bill?token="+e).then(function(a){a.data.response?d.resolve(a.data):d.reject(a.data)},function(a){d.reject(a)}),d.promise},e.getBill=function(d){var e=b.defer(),f=c.get("token");return a.get("/api/v4/events/retrieve/"+d+"?token="+f).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.updateBill=function(d){var e=b.defer(),f=c.get("token");return a.put("/api/v4/events/update/"+d._id+"?token="+f,d).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.getAllMenus=function(){var e=b.defer(),f=c.get("token");return d.menus&&d.menus.length?e.resolve({data:d.menus}):a.get("/api/v4/menu?token="+f).then(function(a){a.data.response?(d.menus=a.data.data,e.resolve(a.data)):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.getMenu=function(d){var e=b.defer(),f=c.get("token");return a.get("/api/v4/menus/"+d+"?token="+f).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.createMenu=function(d){var e=b.defer(),f=c.get("token");return a.post("/api/v4/menu?token="+f,d).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.updateMenu=function(d){var e=b.defer(),f=c.get("token");return a.put("/api/v4/menus/"+d._id+"?token="+f,d).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.cloneMenu=function(d,e){var f=b.defer(),g=c.get("token");return a.post("/api/v4/menus/clone?token="+g,{menu:d,outlet:e}).then(function(a){a.data.response?f.resolve(a.data):f.reject(a.data)},function(a){f.reject(a)}),f.promise},e.deleteMenu=function(d){var e=b.defer(),f=c.get("token");return a["delete"]("/api/v4/menus/"+d+"?token="+f).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.getLocations=function(){var c=b.defer();return a.get("/api/v4/locations").then(function(a){a.data.response?c.resolve(a.data):c.reject(a.data)},function(a){c.reject(a)}),c.promise},e.getOrders=function(d){var e=b.defer(),f=c.get("token");return a.get("/api/v4/outlet/orders/"+d+"?token="+f).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.updateOrder=function(d){var e=b.defer(),f=c.get("token");return a.put("/api/v4/outlet/order/"+d._id+"?token="+f,d).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.getOrder=function(d){var e=b.defer(),f=c.get("token");return a.get("/api/v4/order/"+d+"?token="+f).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e.menuUpdateRequest=function(d){var e=b.defer(),f=c.get("token");return a.post("/api/v4/menu/request_update?token="+f,d).then(function(a){a.data.response?e.resolve(a.data):e.reject(a.data)},function(a){e.reject(a)}),e.promise},e}]);